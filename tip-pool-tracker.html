<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tip Pool Tracker</title>
        <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #090b12;
            color: #f1f5f9;
        }
        .glass {
            background: rgba(23, 26, 35, 0.85);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(148, 163, 184, 0.08);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
        }
        .badge-pill {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .icon-button {
            transition: all 0.2s ease;
        }
        .icon-button:hover {
            transform: translateY(-1px) scale(1.02);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            animation: slideIn 0.4s ease-out;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
    <body class="bg-gradient-to-br from-slate-950 via-slate-900 to-indigo-950 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const APP_SERVER_PORT = parseInt(window.TIP_POOL_APP_PORT || '8000', 10);
        const CONTROL_SERVER_ORIGIN = window.TIP_POOL_CONTROL_ORIGIN || 'http://localhost:4100';

        const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        async function fetchControlServerStatus() {
            try {
                const response = await fetch(`${CONTROL_SERVER_ORIGIN}/server/status`, { mode: 'cors' });
                if (!response.ok) {
                    return { ok: false, error: new Error(`Status ${response.status}`) };
                }
                const body = await response.json();
                return { ok: true, body };
            } catch (error) {
                return { ok: false, error };
            }
        }

        async function ensureAppServerRunning({ retries = 3, waitMs = 600 } = {}) {
            let lastStatus = null;
            let lastError = null;

            for (let attempt = 0; attempt <= retries; attempt++) {
                const statusResult = await fetchControlServerStatus();
                if (statusResult.ok && statusResult.body.running) {
                    return { ok: true, status: statusResult.body, attempts: attempt + 1 };
                }

                if (!statusResult.ok) {
                    lastError = statusResult.error;
                } else {
                    lastStatus = statusResult.body;
                }

                try {
                    await fetch(`${CONTROL_SERVER_ORIGIN}/server/start`, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                    });
                } catch (error) {
                    lastError = error;
                }

                await wait(waitMs * (attempt + 1));
            }

            return { ok: false, status: lastStatus, error: lastError };
        }

        // Google Sheets API Configuration
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        // Google Sheets Helper Functions
        class GoogleSheetsAPI {
            constructor() {
                this.gapiLoaded = false;
                this.gisLoaded = false;
                this.tokenClient = null;
                this.accessToken = null;
            }

            async initialize(clientId, apiKey) {
                return new Promise((resolve, reject) => {
                    if (typeof gapi === 'undefined') {
                        reject('Google API not loaded');
                        return;
                    }

                    gapi.load('client', async () => {
                        try {
                            await gapi.client.init({
                                apiKey: apiKey,
                                discoveryDocs: DISCOVERY_DOCS,
                            });
                            this.gapiLoaded = true;
                            
                            // Initialize GIS
                            if (typeof google !== 'undefined' && google.accounts) {
                                this.tokenClient = google.accounts.oauth2.initTokenClient({
                                    client_id: clientId,
                                    scope: SCOPES,
                                    callback: (response) => {
                                        if (response.access_token) {
                                            this.accessToken = response.access_token;
                                        }
                                    },
                                });
                                this.gisLoaded = true;
                            }
                            
                            resolve(true);
                        } catch (error) {
                            reject(error);
                        }
                    });
                });
            }

            requestAccessToken() {
                return new Promise((resolve) => {
                    if (this.tokenClient) {
                        this.tokenClient.callback = (response) => {
                            if (response.access_token) {
                                this.accessToken = response.access_token;
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        };
                        this.tokenClient.requestAccessToken();
                    } else {
                        resolve(false);
                    }
                });
            }

            async readData(spreadsheetId, range) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: spreadsheetId,
                        range: range,
                    });
                    return response.result.values || [];
                } catch (error) {
                    console.error('Error reading data:', error);
                    throw error;
                }
            }

            async writeData(spreadsheetId, range, values) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: range,
                        valueInputOption: 'RAW',
                        resource: { values: values },
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error writing data:', error);
                    throw error;
                }
            }

            async appendData(spreadsheetId, range, values) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: spreadsheetId,
                        range: range,
                        valueInputOption: 'RAW',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values: values },
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error appending data:', error);
                    throw error;
                }
            }

            async deleteRow(spreadsheetId, sheetId, rowIndex) {
                try {
                    const response = await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: spreadsheetId,
                        resource: {
                            requests: [{
                                deleteDimension: {
                                    range: {
                                        sheetId: sheetId,
                                        dimension: 'ROWS',
                                        startIndex: rowIndex,
                                        endIndex: rowIndex + 1,
                                    },
                                },
                            }],
                        },
                    });
                    return response.result;
                } catch (error) {
                    console.error('Error deleting row:', error);
                    throw error;
                }
            }
        }

        const sheetsAPI = new GoogleSheetsAPI();

        // Main App Component
        function App() {
            const [view, setView] = useState('list'); // list, create, edit, view
            const [shifts, setShifts] = useState([]);
              const [currentShift, setCurrentShift] = useState(null);
              const [isAuthenticated, setIsAuthenticated] = useState(false);
              const [config, setConfig] = useState({
                  clientId: '',
                  apiKey: '',
                  spreadsheetId: '',
                  sheetName: 'Shifts',
              });
            const [showConfig, setShowConfig] = useState(true);
              const [loading, setLoading] = useState(false);
              const [error, setError] = useState(null);
              const [serverStatus, setServerStatus] = useState({
                  state: 'checking',
                  message: `Ensuring local server is running on port ${APP_SERVER_PORT}...`,
              });
            const [coworkerDirectory, setCoworkerDirectory] = useState([]);

              useEffect(() => {
                  let cancelled = false;

                  const bootServer = async () => {
                      if (typeof fetch === 'undefined') {
                          if (!cancelled) {
                              setServerStatus({
                                  state: 'error',
                                  message: 'Fetch API is unavailable; cannot communicate with the local control server.',
                              });
                          }
                          return;
                      }

                      setServerStatus((prev) => ({
                          state: 'checking',
                          message: prev.message || `Ensuring local server is running on port ${APP_SERVER_PORT}...`,
                      }));

                      const result = await ensureAppServerRunning();
                      if (cancelled) return;

                      if (result.ok) {
                          setServerStatus({ state: 'ready', message: '' });
                      } else {
                          const reason = result.error?.message || 'Control server is not reachable';
                            setServerStatus({
                                state: 'error',
                                message: `Could not auto-start the local server on port ${APP_SERVER_PORT}. ${reason}. Try running "node control-server.js" or "./start-server.sh ${APP_SERVER_PORT}" in a terminal, then refresh.`,
                            });
                      }
                  };

                  bootServer();

                  return () => {
                      cancelled = true;
                  };
              }, []);

            // Load configuration from localStorage
            useEffect(() => {
                const savedConfig = localStorage.getItem('tipPoolConfig');
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    setConfig(parsed);
                    if (parsed.clientId && parsed.apiKey) {
                        setShowConfig(false);
                        initializeGoogleAPI(parsed);
                    }
                }
            }, []);

            const initializeGoogleAPI = async (cfg) => {
                try {
                    await sheetsAPI.initialize(cfg.clientId, cfg.apiKey);
                    console.log('Google API initialized');
                    if (typeof gapi !== 'undefined' && gapi?.client?.getToken) {
                        const token = gapi.client.getToken();
                        if (token) {
                            setIsAuthenticated(true);
                        }
                    }
                } catch (error) {
                    setError('Failed to initialize Google API: ' + error.message);
                }
            };

            const handleAuthenticate = async () => {
                setLoading(true);
                setError(null);
                try {
                    const success = await sheetsAPI.requestAccessToken();
                    if (success) {
                        setIsAuthenticated(true);
                    } else {
                        setError('Authentication failed');
                    }
                } catch (error) {
                    setError('Authentication error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveConfig = () => {
                localStorage.setItem('tipPoolConfig', JSON.stringify(config));
                setShowConfig(false);
                initializeGoogleAPI(config);
            };

            const loadShifts = async () => {
                if (!config.spreadsheetId || !isAuthenticated) return;
                
                setLoading(true);
                setError(null);
                try {
                    const range = `${config.sheetName}!A2:B`;
                    const data = await sheetsAPI.readData(config.spreadsheetId, range);
                    
                    const loadedShifts = data.map((row, index) => ({
                        rowIndex: index + 2,
                        id: row[0] || `shift_${Date.now()}_${index}`,
                        data: row[1] ? JSON.parse(row[1]) : null,
                    })).filter(shift => shift.data);
                    
                    setShifts(loadedShifts);
                } catch (error) {
                    setError('Failed to load shifts: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const loadCoworkerDirectory = useCallback(async () => {
                if (!config.spreadsheetId || !isAuthenticated) return;
                try {
                    const rows = await sheetsAPI.readData(config.spreadsheetId, 'Coworkers!A2:F');
                    const directory = (rows || [])
                        .map((row, index) => {
                            const [trappeId, name, firstName, lastName, positionsRaw, managerRaw] = row;
                            const fallbackName = [firstName, lastName].filter(Boolean).join(' ');
                            const normalizedName = (name || fallbackName || '').trim();
                            if (!normalizedName) return null;
                            const positions = (positionsRaw || '')
                                .split(/[,/]/)
                                .map((token) => token.trim())
                                .filter(Boolean);
                            const positionsNormalized = positions.map((p) => p.toLowerCase());
                            const managerFlag = String(managerRaw || '').trim().toLowerCase();
                            const isManager = managerFlag === 'true' || managerFlag === 'yes' || managerFlag === '1';
                            const isSelf =
                                normalizedName.toLowerCase() === 'ian' ||
                                (firstName || '').trim().toLowerCase() === 'ian';
                            return {
                                id: trappeId || `coworker_${index}`,
                                name: normalizedName,
                                firstName: firstName || '',
                                lastName: lastName || '',
                                positions,
                                positionsNormalized,
                                isManager,
                                isSelf,
                            };
                        })
                        .filter(Boolean);
                    setCoworkerDirectory(directory);
                } catch (directoryError) {
                    console.warn('Failed to load coworker directory', directoryError);
                    setCoworkerDirectory([]);
                }
            }, [config.spreadsheetId, isAuthenticated]);

            useEffect(() => {
                if (!isAuthenticated || !config.spreadsheetId) return;
                loadShifts();
            }, [isAuthenticated, config.spreadsheetId, config.sheetName]);

            useEffect(() => {
                if (!isAuthenticated || !config.spreadsheetId) return;
                loadCoworkerDirectory();
            }, [isAuthenticated, config.spreadsheetId, loadCoworkerDirectory]);

            const saveShift = async (shiftData) => {
                if (!config.spreadsheetId || !isAuthenticated) return;
                
                setLoading(true);
                setError(null);
                try {
                    const id = shiftData.id || `shift_${shiftData.date.replace(/-/g, '')}`;
                    const jsonData = JSON.stringify(shiftData);
                    
                    // Check if shift exists
                    const existingIndex = shifts.findIndex(s => s.id === id);
                    
                    if (existingIndex >= 0) {
                        // Update existing
                        const range = `${config.sheetName}!A${shifts[existingIndex].rowIndex}:B${shifts[existingIndex].rowIndex}`;
                        await sheetsAPI.writeData(config.spreadsheetId, range, [[id, jsonData]]);
                    } else {
                        // Append new
                        const range = `${config.sheetName}!A:B`;
                        await sheetsAPI.appendData(config.spreadsheetId, range, [[id, jsonData]]);
                    }
                    
                    await loadShifts();
                    setView('list');
                } catch (error) {
                    setError('Failed to save shift: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const deleteShift = async (shiftId) => {
                if (!config.spreadsheetId || !isAuthenticated) return;
                
                if (!confirm('Are you sure you want to delete this shift?')) return;
                
                setLoading(true);
                setError(null);
                try {
                    const shiftIndex = shifts.findIndex(s => s.id === shiftId);
                    if (shiftIndex >= 0) {
                        // Note: This is simplified - you'd need the sheet ID for proper deletion
                        // For now, we'll clear the row and reload
                        const range = `${config.sheetName}!A${shifts[shiftIndex].rowIndex}:B${shifts[shiftIndex].rowIndex}`;
                        await sheetsAPI.writeData(config.spreadsheetId, range, [['', '']]);
                        await loadShifts();
                    }
                } catch (error) {
                    setError('Failed to delete shift: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const editShift = (shift) => {
                setCurrentShift(shift.data);
                setView('edit');
            };

            const viewShift = (shift) => {
                setCurrentShift(shift.data);
                setView('view');
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <header className="glass rounded-2xl shadow-xl p-6 mb-6 animate-slide-in border border-slate-800/40">
                            <div className="flex items-center justify-between flex-wrap gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="bg-gradient-to-br from-cyan-500 to-fuchsia-500 p-3 rounded-xl text-white text-2xl">
                                        <i className="fas fa-coins"></i>
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-slate-100">
                                            Tip Pool Tracker
                                        </h1>
                                        <p className="text-slate-400 text-sm">Track your shifts, tips, and earnings</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {isAuthenticated && (
                                        <button
                                            onClick={() => setView('create')}
                                            className="bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white px-6 py-2.5 rounded-xl hover:shadow-lg hover:shadow-cyan-500/30 transition-all duration-300 flex items-center gap-2"
                                        >
                                            <i className="fas fa-plus"></i>
                                            New Shift
                                        </button>
                                    )}
                                    <button
                                        onClick={() => setShowConfig(!showConfig)}
                                        className="bg-slate-900/70 text-slate-200 px-4 py-2.5 rounded-xl hover:bg-slate-800 transition-all duration-300 border border-slate-700"
                                    >
                                        <i className="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                        </header>

                        {serverStatus.state !== 'ready' && (
                            <div
                                className={`glass rounded-xl shadow-lg p-4 mb-6 border ${
                                    serverStatus.state === 'error'
                                        ? 'border-red-500/40 bg-red-500/10'
                                        : 'border-cyan-500/40 bg-cyan-500/10'
                                } animate-slide-in`}
                            >
                                <div className="flex items-start gap-3">
                                    <div
                                        className={`text-xl ${
                                            serverStatus.state === 'error'
                                                ? 'text-red-300'
                                                : 'text-cyan-300'
                                        }`}
                                    >
                                        <i
                                            className={`fas ${
                                                serverStatus.state === 'error'
                                                    ? 'fa-exclamation-triangle'
                                                    : 'fa-rocket'
                                            }`}
                                        ></i>
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm font-semibold text-slate-100">
                                            {serverStatus.state === 'error'
                                                ? 'Server Not Ready'
                                                : 'Starting Local Server'}
                                        </p>
                                        <p className="text-sm text-slate-300 mt-1">
                                            {serverStatus.message}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Error Alert */}
                        {error && (
                            <div className="glass rounded-xl p-4 mb-6 border border-red-500/30 bg-red-500/10 animate-slide-in">
                                <div className="flex items-center gap-3">
                                    <i className="fas fa-exclamation-triangle text-red-300 text-xl"></i>
                                    <div className="flex-1">
                                        <p className="text-red-200 font-medium">Error</p>
                                        <p className="text-red-300 text-sm">{error}</p>
                                    </div>
                                    <button onClick={() => setError(null)} className="text-red-300 hover:text-red-100">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Configuration Panel */}
                        {showConfig && (
                            <ConfigPanel
                                config={config}
                                setConfig={setConfig}
                                saveConfig={saveConfig}
                                isAuthenticated={isAuthenticated}
                                handleAuthenticate={handleAuthenticate}
                                loading={loading}
                            />
                        )}

                        {/* Main Content */}
                        {!showConfig && isAuthenticated && (
                            <>
                                {view === 'list' && (
                                    <div className="space-y-6">
                                        <ShiftList
                                            shifts={shifts}
                                            onEdit={editShift}
                                            onDelete={deleteShift}
                                            onView={viewShift}
                                            loading={loading}
                                            onRefresh={loadShifts}
                                        />
                                        <ChartsPanel shifts={shifts} />
                                    </div>
                                )}
                                {view === 'create' && (
                                    <ShiftForm
                                        onSave={saveShift}
                                          onCancel={() => setView('list')}
                                          coworkerDirectory={coworkerDirectory}
                                    />
                                )}
                                {view === 'edit' && currentShift && (
                                    <ShiftForm
                                        shift={currentShift}
                                        onSave={saveShift}
                                          onCancel={() => setView('list')}
                                          coworkerDirectory={coworkerDirectory}
                                    />
                                )}
                                {view === 'view' && currentShift && (
                                    <ShiftDetail
                                        shift={currentShift}
                                        onEdit={() => setView('edit')}
                                        onClose={() => setView('list')}
                                    />
                                )}
                            </>
                        )}

                        {/* Not Authenticated */}
                        {!showConfig && !isAuthenticated && (
                            <div className="glass rounded-2xl shadow-xl p-12 text-center animate-slide-in border border-slate-800/40">
                                <div className="bg-slate-900/70 w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center">
                                    <i className="fas fa-lock text-4xl text-slate-200"></i>
                                </div>
                                <h2 className="text-2xl font-bold text-slate-100 mb-3">Authentication Required</h2>
                                <p className="text-slate-400 mb-6">Connect to Google Sheets to start tracking your shifts</p>
                                <button
                                    onClick={handleAuthenticate}
                                    disabled={loading}
                                    className="bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white px-8 py-3 rounded-xl hover:shadow-lg hover:shadow-cyan-500/30 transition-all duration-300 disabled:opacity-50"
                                >
                                    {loading ? 'Connecting...' : 'Connect Google Sheets'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Configuration Panel Component
        function ConfigPanel({ config, setConfig, saveConfig, isAuthenticated, handleAuthenticate, loading }) {
            return (
                <div className="glass rounded-2xl shadow-xl p-6 mb-6 animate-slide-in border border-slate-800/40">
                    <h2 className="text-2xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                        <i className="fas fa-cog text-cyan-300"></i>
                        Configuration
                    </h2>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Google Client ID
                            </label>
                            <input
                                type="text"
                                value={config.clientId}
                                onChange={(e) => setConfig({ ...config, clientId: e.target.value })}
                                className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-slate-100"
                                placeholder="Your Google OAuth Client ID"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Google API Key
                            </label>
                            <input
                                type="text"
                                value={config.apiKey}
                                onChange={(e) => setConfig({ ...config, apiKey: e.target.value })}
                                className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-slate-100"
                                placeholder="Your Google API Key"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Spreadsheet ID
                            </label>
                            <input
                                type="text"
                                value={config.spreadsheetId}
                                onChange={(e) => setConfig({ ...config, spreadsheetId: e.target.value })}
                                className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-slate-100"
                                placeholder="Google Sheets ID from URL"
                            />
                            <p className="text-xs text-slate-500 mt-1">
                                Found in the URL: docs.google.com/spreadsheets/d/<span className="font-mono">SPREADSHEET_ID</span>/edit
                            </p>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Sheet Name
                            </label>
                            <input
                                type="text"
                                value={config.sheetName}
                                onChange={(e) => setConfig({ ...config, sheetName: e.target.value })}
                                className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-slate-100"
                                placeholder="Shifts"
                            />
                        </div>

                        <div className="flex gap-3 pt-4">
                            <button
                                onClick={saveConfig}
                                className="flex-1 bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white px-6 py-2.5 rounded-xl hover:shadow-lg hover:shadow-cyan-500/30 transition-all duration-300"
                            >
                                Save Configuration
                            </button>
                            {!isAuthenticated && config.clientId && config.apiKey && (
                                <button
                                    onClick={handleAuthenticate}
                                    disabled={loading}
                                    className="flex-1 bg-emerald-500 text-white px-6 py-2.5 rounded-xl hover:bg-emerald-600 transition-all duration-300 disabled:opacity-50"
                                >
                                    {loading ? 'Connecting...' : 'Authenticate'}
                                </button>
                            )}
                        </div>

                        <div className="bg-slate-900/70 border border-slate-700 rounded-xl p-4 mt-4">
                            <h3 className="font-semibold text-slate-100 mb-2 flex items-center gap-2">
                                <i className="fas fa-info-circle text-cyan-300"></i>
                                Setup Instructions
                            </h3>
                            <ol className="text-sm text-slate-400 space-y-1 list-decimal list-inside">
                                <li>Create a Google Cloud Project</li>
                                <li>Enable Google Sheets API</li>
                                <li>Create OAuth 2.0 credentials (Web application)</li>
                                <li>Add authorized JavaScript origin: your domain</li>
                                <li>Create an API Key with Sheets API access</li>
                                <li>Create a Google Sheet with columns: ID, JSON Data</li>
                                <li>Copy the Spreadsheet ID from the URL</li>
                            </ol>
                        </div>
                    </div>
                </div>
            );
        }

        function MonthlyCalendar({ shifts, onSelectShift }) {
            const [activeMonth, setActiveMonth] = useState(() => {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), 1);
            });

            const shiftByDate = useMemo(() => {
                const map = new Map();
                shifts.forEach((shift) => {
                    const dateKey = shift.data?.date;
                    if (!dateKey) return;
                    if (!map.has(dateKey)) {
                        map.set(dateKey, []);
                    }
                    map.get(dateKey).push(shift);
                });
                return map;
            }, [shifts]);

            const monthLabel = activeMonth.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric',
            });

            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            const calendarCells = useMemo(() => {
                const cells = [];
                const year = activeMonth.getFullYear();
                const month = activeMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                const leadingPad = firstDay.getDay();
                const totalDays = lastDay.getDate();
                const totalCells = Math.ceil((leadingPad + totalDays) / 7) * 7;

                for (let i = 0; i < leadingPad; i += 1) {
                    const date = new Date(year, month, i - leadingPad + 1);
                    cells.push({ type: 'pad', date });
                }

                for (let day = 1; day <= totalDays; day += 1) {
                    const date = new Date(year, month, day);
                    const dateKey = date.toISOString().split('T')[0];
                    const shiftsForDay = shiftByDate.get(dateKey) || [];
                    cells.push({
                        type: 'day',
                        date,
                        dateKey,
                        shifts: shiftsForDay,
                    });
                }

                const trailingNeeded = totalCells - cells.length;
                for (let i = 1; i <= trailingNeeded; i += 1) {
                    const date = new Date(year, month + 1, i);
                    cells.push({ type: 'pad', date });
                }

                return cells;
            }, [activeMonth, shiftByDate]);

            const goToMonth = (offset) => {
                setActiveMonth((prev) => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
            };

            const isToday = (date) => {
                const today = new Date();
                return (
                    date.getFullYear() === today.getFullYear() &&
                    date.getMonth() === today.getMonth() &&
                    date.getDate() === today.getDate()
                );
            };

            return (
                <div className="glass rounded-xl shadow-lg p-4 border border-slate-800/40">
                    <div className="flex items-center justify-between mb-3">
                        <div>
                            <h3 className="text-sm font-semibold text-slate-100">Shift Calendar</h3>
                            <p className="text-xs text-slate-400">{monthLabel}</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <button
                                type="button"
                                onClick={() => goToMonth(-1)}
                                className="px-2 py-1 rounded-lg border border-slate-700 text-slate-300 hover:border-cyan-500 text-xs"
                                aria-label="Previous month"
                            >
                                <i className="fas fa-chevron-left"></i>
                            </button>
                            <button
                                type="button"
                                onClick={() => goToMonth(1)}
                                className="px-2 py-1 rounded-lg border border-slate-700 text-slate-300 hover:border-cyan-500 text-xs"
                                aria-label="Next month"
                            >
                                <i className="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-[11px] text-slate-400 mb-2">
                        {daysOfWeek.map((day) => (
                            <div key={day} className="uppercase tracking-wide">
                                {day}
                            </div>
                        ))}
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center">
                        {calendarCells.map((cell, index) => {
                            if (cell.type === 'pad') {
                                return <div key={`pad-${index}`} className="h-14 rounded-lg bg-slate-900/40 border border-slate-900/60"></div>;
                            }
                            const shiftCount = cell.shifts.length;
                            const hasShifts = shiftCount > 0;
                            const tooltip = hasShifts
                                ? cell.shifts
                                      .map((s) => {
                                            const earnings = Number(s.data.earnings?.total ?? 0);
                                            return `${s.data.myName || 'Shift'} â€¢ $${earnings.toFixed(2)}`;
                                      })
                                      .join('\n')
                                : '';

                            return (
                                <button
                                    key={cell.dateKey}
                                    type="button"
                                    onClick={() => hasShifts && onSelectShift && onSelectShift(cell.shifts[0])}
                                    title={tooltip}
                                    className={`h-14 rounded-lg border text-xs flex flex-col items-center justify-center gap-1 transition
                                        ${hasShifts ? 'bg-cyan-500/15 border-cyan-400/40 text-cyan-100 hover:bg-cyan-500/25' : 'bg-slate-900/50 border-slate-800/60 text-slate-300'}
                                        ${isToday(cell.date) ? 'ring-1 ring-cyan-400/60' : ''}`}
                                >
                                    <span className="font-semibold text-sm">{cell.date.getDate()}</span>
                                    {hasShifts && <span className="px-2 py-0.5 rounded-full bg-cyan-500/30 text-[10px]">{shiftCount} shift{shiftCount > 1 ? 's' : ''}</span>}
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Shift List Component
        function ShiftList({ shifts, onEdit, onDelete, onView, loading, onRefresh }) {
            const [sortBy, setSortBy] = useState('date');
            const [filterType, setFilterType] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');

            const filteredShifts = useMemo(() => {
                let filtered = [...shifts];

                // Filter by type
                if (filterType !== 'all') {
                    filtered = filtered.filter(s => s.data.type === filterType);
                }

                // Search
                if (searchTerm) {
                    filtered = filtered.filter(s => 
                        s.data.date.includes(searchTerm) ||
                        s.data.myName?.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                // Sort
                filtered.sort((a, b) => {
                    if (sortBy === 'date') {
                        return new Date(b.data.date) - new Date(a.data.date);
                    } else if (sortBy === 'earnings') {
                        return (b.data.earnings?.total || 0) - (a.data.earnings?.total || 0);
                    }
                    return 0;
                });

                return filtered;
            }, [shifts, sortBy, filterType, searchTerm]);

            const stats = useMemo(() => {
                const totalEarnings = shifts.reduce((sum, s) => sum + (s.data.earnings?.total || 0), 0);
                const totalHours = shifts.reduce((sum, s) => sum + (s.data.summary?.hours || 0), 0);
                const avgHourly = totalHours > 0 ? totalEarnings / totalHours : 0;

                return { totalEarnings, totalHours, avgHourly, shiftCount: shifts.length };
            }, [shifts]);

            return (
                <div className="space-y-6 animate-slide-in">
                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <StatCard
                            icon="fa-calendar-check"
                            label="Total Shifts"
                            value={stats.shiftCount}
                            gradient="from-blue-500 to-blue-600"
                        />
                        <StatCard
                            icon="fa-dollar-sign"
                            label="Total Earnings"
                            value={`$${stats.totalEarnings.toFixed(2)}`}
                            gradient="from-green-500 to-green-600"
                        />
                        <StatCard
                            icon="fa-clock"
                            label="Total Hours"
                            value={stats.totalHours.toFixed(1)}
                            gradient="from-purple-500 to-purple-600"
                        />
                        <StatCard
                            icon="fa-chart-line"
                            label="Avg Hourly"
                            value={`$${stats.avgHourly.toFixed(2)}`}
                            gradient="from-orange-500 to-orange-600"
                        />
                    </div>

                    <MonthlyCalendar shifts={shifts} onSelectShift={onView} />

                    {/* Filters */}
                    <div className="glass rounded-xl shadow-lg p-4 border border-slate-800/40">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Search</label>
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Search by date or name..."
                                    className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 text-slate-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Filter by Type</label>
                                <select
                                    value={filterType}
                                    onChange={(e) => setFilterType(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 text-slate-100"
                                >
                                    <option value="all">All Shifts</option>
                                    <option value="day">Day Shifts</option>
                                    <option value="night">Night Shifts</option>
                                    <option value="double">Double Shifts</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Sort By</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => setSortBy(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-900/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-cyan-500 text-slate-100"
                                >
                                    <option value="date">Date (Newest First)</option>
                                    <option value="earnings">Earnings (Highest First)</option>
                                </select>
                            </div>
                        </div>
                        <button
                            onClick={onRefresh}
                            disabled={loading}
                            className="mt-4 w-full bg-slate-900/70 text-cyan-200 px-4 py-2 rounded-xl border border-slate-700 hover:border-cyan-500 transition-all duration-300 disabled:opacity-50"
                        >
                            <i className="fas fa-sync-alt mr-2"></i>
                            {loading ? 'Refreshing...' : 'Refresh Data'}
                        </button>
                    </div>

                    {/* Shift Cards */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                        {filteredShifts.length === 0 ? (
                            <div className="col-span-full glass rounded-xl p-12 text-center border border-slate-800/40">
                                <i className="fas fa-inbox text-6xl text-slate-600 mb-4"></i>
                                <p className="text-slate-300 text-lg">No shifts found</p>
                                <p className="text-slate-500 text-sm">Create your first shift to get started</p>
                            </div>
                        ) : (
                            filteredShifts.map((shift) => (
                                <ShiftCard
                                    key={shift.id}
                                    shift={shift}
                                    onView={() => onView(shift)}
                                    onEdit={() => onEdit(shift)}
                                    onDelete={() => onDelete(shift.id)}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        }

        function ChartsPanel({ shifts }) {
            const lineRef = useRef(null);
            const lineChartRef = useRef(null);
            const barRef = useRef(null);
            const barChartRef = useRef(null);
            const [chartSpan, setChartSpan] = useState(14);

            const spanOptions = [7, 14, 30, 60];

            const recentShifts = useMemo(() => {
                const sorted = [...shifts].sort((a, b) => new Date(a.data.date) - new Date(b.data.date));
                return sorted.slice(-chartSpan);
            }, [shifts, chartSpan]);

            useEffect(() => {
                if (!window.Chart || !lineRef.current) return;

                const labels = recentShifts.map((shift) => new Date(shift.data.date).toLocaleDateString());
                const hourlySeries = recentShifts.map((shift) => shift.data.summary?.hourly || 0);
                const tipsPerHourSeries = recentShifts.map((shift) => shift.data.summary?.tips?.actual?.perHour || 0);

                const ctx = lineRef.current.getContext('2d');
                if (lineChartRef.current) {
                    lineChartRef.current.destroy();
                }
                lineChartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Hourly Earnings',
                                data: hourlySeries,
                                borderColor: '#22d3ee',
                                backgroundColor: 'rgba(34, 211, 238, 0.15)',
                                tension: 0.35,
                                fill: true,
                            },
                            {
                                label: 'Tips per Hour',
                                data: tipsPerHourSeries,
                                borderColor: '#c084fc',
                                backgroundColor: 'rgba(192, 132, 252, 0.15)',
                                tension: 0.35,
                                fill: true,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.2)' },
                            },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                beginAtZero: true,
                            },
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' },
                            },
                            tooltip: {
                                backgroundColor: '#0f172a',
                                borderColor: '#22d3ee',
                                borderWidth: 1,
                            },
                        },
                    },
                });

                return () => {
                    if (lineChartRef.current) {
                        lineChartRef.current.destroy();
                        lineChartRef.current = null;
                    }
                };
            }, [recentShifts]);

            useEffect(() => {
                if (!window.Chart || !barRef.current) return;

                const ctx = barRef.current.getContext('2d');
                if (barChartRef.current) {
                    barChartRef.current.destroy();
                }

                const earningsBars = shifts.slice(-8).map((shift) => shift.data.earnings || {});
                const barLabels = shifts.slice(-8).map((shift) => new Date(shift.data.date).toLocaleDateString());

                barChartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: barLabels,
                        datasets: [
                            {
                                label: 'Tips',
                                data: earningsBars.map((earn) => earn.tips || 0),
                                backgroundColor: 'rgba(34, 211, 238, 0.6)',
                            },
                            {
                                label: 'Wage',
                                data: earningsBars.map((earn) => earn.wage || 0),
                                backgroundColor: 'rgba(192, 132, 252, 0.6)',
                            },
                            {
                                label: 'Other',
                                data: earningsBars.map((earn) => (earn.total || 0) - (earn.tips || 0) - (earn.wage || 0)),
                                backgroundColor: 'rgba(74, 222, 128, 0.6)',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.15)' },
                            },
                            y: {
                                stacked: true,
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(148, 163, 184, 0.15)' },
                                beginAtZero: true,
                            },
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' },
                            },
                            tooltip: {
                                backgroundColor: '#0f172a',
                                borderColor: '#38bdf8',
                                borderWidth: 1,
                            },
                        },
                    },
                });

                return () => {
                    if (barChartRef.current) {
                        barChartRef.current.destroy();
                        barChartRef.current = null;
                    }
                };
            }, [shifts]);

            return (
                <div className="glass rounded-2xl shadow-xl p-6 border border-slate-800/40 space-y-6">
                    <div className="flex items-center justify-between flex-wrap gap-3">
                        <div>
                            <h3 className="text-lg font-semibold text-slate-100">Shift Analytics</h3>
                            <span className="text-xs uppercase tracking-widest text-slate-500">Last {recentShifts.length} Shifts</span>
                        </div>
                        <div className="flex items-center gap-2">
                            {spanOptions.map((option) => (
                                <button
                                    key={option}
                                    type="button"
                                    onClick={() => setChartSpan(option)}
                                    className={`text-xs px-3 py-1.5 rounded-lg border transition ${
                                        chartSpan === option
                                            ? 'border-cyan-400 bg-cyan-500/20 text-cyan-100'
                                            : 'border-slate-700 bg-slate-900/60 text-slate-400 hover:border-slate-500'
                                    }`}
                                >
                                    {option}d
                                </button>
                            ))}
                        </div>
                    </div>

                    {recentShifts.length === 0 ? (
                        <p className="text-sm text-slate-500">Add a few shifts to unlock charts.</p>
                    ) : (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-slate-900/60 border border-slate-800/60 rounded-2xl p-4 h-72">
                                <h4 className="text-sm text-slate-300 mb-3">Hourly Earnings vs Tips</h4>
                                <canvas ref={lineRef}></canvas>
                            </div>
                            <div className="bg-slate-900/60 border border-slate-800/60 rounded-2xl p-4 h-72">
                                <h4 className="text-sm text-slate-300 mb-3">Recent Earnings Breakdown</h4>
                                <canvas ref={barRef}></canvas>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Stat Card Component
        function StatCard({ icon, label, value, gradient }) {
            return (
                <div className="glass rounded-xl shadow-lg p-6 card-hover border border-slate-800/40">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-slate-400 text-xs uppercase tracking-wider mb-1">{label}</p>
                            <p className="text-2xl font-bold text-slate-100">{value}</p>
                        </div>
                        <div className={`bg-gradient-to-br ${gradient} p-3 rounded-lg text-white text-xl`}>
                            <i className={`fas ${icon}`}></i>
                        </div>
                    </div>
                </div>
            );
        }

        // Shift Card Component
        function ShiftCard({ shift, onView, onEdit, onDelete }) {
            const data = shift.data;

            const toNumber = (value) => {
                if (typeof value === 'number') return value;
                const num = parseFloat(value);
                return Number.isNaN(num) ? 0 : num;
            };

            const shiftLabel = data.type ? `${data.type.charAt(0).toUpperCase() + data.type.slice(1)} Shift` : 'Unassigned Shift';
            const typeMeta = SHIFT_TYPE_META[data.type] || SHIFT_TYPE_META.default;

            const handleHeaderClick = () => {
                if (onView) onView();
            };

            const hoverSummary = [
                `Total: $${toNumber(data.earnings?.total || 0).toFixed(2)}`,
                `Hours: ${toNumber(data.summary?.hours || 0).toFixed(1)}h`,
                `Tips: $${toNumber(data.tips?._total || 0).toFixed(2)}`,
            ].join(' â€¢ ');

            return (
                <div className="glass rounded-2xl shadow-sm overflow-hidden border border-slate-800/40 transition-all hover:shadow-lg hover:border-cyan-500/40">
                    <button
                        type="button"
                        onClick={handleHeaderClick}
                        title={hoverSummary}
                        className="w-full text-left px-4 py-3 bg-slate-900/70 border-b border-slate-800/60 flex items-center justify-between gap-3 hover:bg-slate-900/90"
                    >
                        <div>
                            <p className="text-xs uppercase tracking-wide text-slate-400">
                                {new Date(data.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                            </p>
                            <p className="text-base font-semibold text-slate-100 truncate">{data.myName || 'Unnamed Shift'}</p>
                        </div>
                        <span className="badge-pill bg-slate-800 text-slate-200 border border-slate-700 flex items-center gap-1">
                            <i className={`fas ${typeMeta.icon || 'fa-circle-half-stroke'}`}></i>
                            {shiftLabel}
                        </span>
                    </button>
                    <div className="px-4 py-3 space-y-2 text-xs text-slate-300">
                        <div className="flex justify-between">
                            <span>Total</span>
                            <span className="font-semibold text-emerald-300">${toNumber(data.earnings?.total || 0).toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                            <span>Hours</span>
                            <span className="font-semibold text-slate-100">{toNumber(data.summary?.hours || 0).toFixed(1)}h</span>
                        </div>
                        <div className="flex justify-between">
                            <span>Hourly</span>
                            <span className="font-semibold text-indigo-300">${toNumber(data.summary?.hourly || 0).toFixed(2)}/hr</span>
                        </div>
                        <div className="flex justify-between">
                            <span>Tips</span>
                            <span className="font-semibold text-cyan-300">${toNumber(data.tips?._total || 0).toFixed(2)}</span>
                        </div>
                    </div>
                    <div className="flex gap-2 px-4 pb-4">
                        <button
                            onClick={onView}
                            className="flex-1 bg-slate-900/80 border border-slate-800 text-slate-200 px-3 py-2 rounded-xl hover:border-cyan-500 transition-all duration-200 text-xs"
                        >
                            <i className="fas fa-eye mr-1.5"></i>View
                        </button>
                        <button
                            onClick={onEdit}
                            className="flex-1 bg-slate-900/80 border border-slate-800 text-slate-200 px-3 py-2 rounded-xl hover:border-fuchsia-500 transition-all duration-200 text-xs"
                        >
                            <i className="fas fa-edit mr-1.5"></i>Edit
                        </button>
                        <button
                            onClick={onDelete}
                            className="flex-1 bg-red-500/80 text-white px-3 py-2 rounded-xl hover:bg-red-500 transition-all duration-200 text-xs"
                        >
                            <i className="fas fa-trash mr-1.5"></i>Delete
                        </button>
                    </div>
                </div>
            );
        }

        const SHIFT_TYPE_META = {
            day: {
                icon: 'fa-sun',
                label: 'Day Shift',
            },
            night: {
                icon: 'fa-moon',
                label: 'Night Shift',
            },
            double: {
                icon: 'fa-infinity',
                label: 'Double Shift',
            },
            default: {
                icon: 'fa-circle-half-stroke',
                label: 'Shift',
            },
        };

        const DEFAULT_SHIFT_TEMPLATE = {
            id: '',
            date: new Date().toISOString().split('T')[0],
            type: '',
            myName: '',
            time: {
                base: { start: '', end: '', hours: 0 },
                present: { start: '', end: '', hours: 0 },
                clock: null,
                tips: null,
                working: null,
            },
            wage: { base: 5.0, hours: 0, total: 0 },
            tips: { _total: 0 },
            cuts: {},
            coworkers: {
                bartenders: [],
                servers: [],
                support: [],
                estimates: {
                    fallbackEnd: '',
                    fallbackActualEnd: '',
                    notes: '',
                },
            },
            parties: {},
            chump: {
                played: false,
                amount: { total: 0, bills: 0, coins: 0 },
                players: [],
                winner: '',
                notes: ''
            },
            overtime: 0,
            consideration: { items: [], net: 0 },
            swindle: { total: 0, movements: [], net: {} },
            drinking: { items: [], totalSBE: 0 },
            earnings: {
                tips: 0,
                wage: 0,
                overtime: 0,
                chump: 0,
                consideration: 0,
                swindle: 0,
                total: 0,
            },
            summary: {
                earnings: 0,
                hours: 0,
                hourly: 0,
                tips: {
                    actual: { total: 0, perHour: 0 },
                },
            },
            meta: {
                tipsPending: false,
                chumpLogged: false,
                notes: '',
            },
        };

        function deepMergeShift(template, override) {
            const clone = JSON.parse(JSON.stringify(template));
            if (!override) return clone;

            const merge = (target, source) => {
                Object.entries(source || {}).forEach(([key, value]) => {
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        target[key] = merge(target[key] ? { ...target[key] } : {}, value);
                    } else {
                        target[key] = value;
                    }
                });
                return target;
            };

            return merge(clone, override);
        }

        function setNestedValue(target, path, value) {
            const keys = path.split('.');
            let cursor = target;
            for (let i = 0; i < keys.length - 1; i += 1) {
                const key = keys[i];
                if (!cursor[key] || typeof cursor[key] !== 'object') {
                    cursor[key] = {};
                }
                cursor = cursor[key];
            }
            cursor[keys[keys.length - 1]] = value;
        }

        function getNestedValue(target, path) {
            const keys = path.split('.');
            let cursor = target;
            for (let i = 0; i < keys.length; i += 1) {
                if (!cursor) return undefined;
                cursor = cursor[keys[i]];
            }
            return cursor;
        }

        function buildInitialTimeDrafts(data = {}) {
            const drafts = {
                base: {
                    start: formatTimeDisplay(data?.time?.base?.start),
                    end: formatTimeDisplay(data?.time?.base?.end),
                },
                buckets: {},
                parties: {},
                wage: {
                    start: formatTimeDisplay(data?.wage?.clock?.start),
                    end: formatTimeDisplay(data?.wage?.clock?.end),
                },
                crew: {
                    bartenders: {},
                    servers: {},
                    support: {},
                    estimates: {},
                },
            };

            ['present', 'clock', 'tips', 'working'].forEach((bucket) => {
                const bucketData = data?.time?.[bucket];
                drafts.buckets[bucket] = {
                    start: formatTimeDisplay(bucketData?.start),
                    end: formatTimeDisplay(bucketData?.end),
                };
            });

            Object.entries(data?.parties || {}).forEach(([id, party]) => {
                drafts.parties[id] = {
                    start: formatTimeDisplay(party?.time?.start),
                    end: formatTimeDisplay(party?.time?.end),
                };
            });

            (data?.coworkers?.bartenders || []).forEach((member, index) => {
                drafts.crew.bartenders[index] = {
                    start: formatTimeDisplay(member?.start),
                    end: formatTimeDisplay(member?.end),
                    actualStart: formatTimeDisplay(member?.actualStart),
                    actualEnd: formatTimeDisplay(member?.actualEnd),
                };
            });

            (data?.coworkers?.servers || []).forEach((member, index) => {
                drafts.crew.servers[index] = {
                    start: formatTimeDisplay(member?.start),
                    end: formatTimeDisplay(member?.end),
                    actualStart: formatTimeDisplay(member?.actualStart),
                    actualEnd: formatTimeDisplay(member?.actualEnd),
                };
            });

            (data?.coworkers?.support || []).forEach((member, index) => {
                drafts.crew.support[index] = {
                    start: formatTimeDisplay(member?.start),
                    end: formatTimeDisplay(member?.end),
                    actualStart: formatTimeDisplay(member?.actualStart),
                    actualEnd: formatTimeDisplay(member?.actualEnd),
                };
            });

            drafts.crew.estimates = {
                fallbackEnd: formatTimeDisplay(data?.coworkers?.estimates?.fallbackEnd),
                fallbackActualEnd: formatTimeDisplay(data?.coworkers?.estimates?.fallbackActualEnd),
            };

            return drafts;
        }

        function calculateHoursBetween(start, end) {
            if (!start || !end) return 0;
            const [startHour, startMin] = start.split(':').map(Number);
            const [endHour, endMin] = end.split(':').map(Number);
            let hours = endHour - startHour + (endMin - startMin) / 60;
            if (hours < 0) hours += 24;
            return Math.round(hours * 100) / 100;
        }

        const MINUTES_IN_DAY = 24 * 60;

        function timeStringToMinutes(time) {
            if (!time || typeof time !== 'string' || !time.includes(':')) return null;
            const [hourStr, minuteStr] = time.split(':');
            const hour = parseInt(hourStr, 10);
            const minutes = parseInt(minuteStr, 10);
            if (Number.isNaN(hour) || Number.isNaN(minutes)) return null;
            return (hour % 24) * 60 + minutes;
        }

        function normalizeMinutesDiff(startMinutes, endMinutes) {
            if (startMinutes == null || endMinutes == null) return null;
            let diff = endMinutes - startMinutes;
            if (diff <= 0) diff += MINUTES_IN_DAY;
            return diff;
        }

        function formatTimeDisplay(time24) {
            if (!time24 || typeof time24 !== 'string' || !time24.includes(':')) return '';
            const [hourStr, minuteStr] = time24.split(':');
            const hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            if (Number.isNaN(hour) || Number.isNaN(minute)) return '';
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 === 0 ? 12 : hour % 12;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
        }

        function parseFlexibleTime(rawInput, { mode = 'general', referenceStart = null, defaultPeriod = null } = {}) {
            const raw = typeof rawInput === 'number' ? rawInput.toString() : (rawInput || '').toString();
            const trimmed = raw.trim();

            if (trimmed === '') {
                return { ok: true, normalized: '', display: '', period: null, raw: '' };
            }

            let working = trimmed.toLowerCase().replace(/\s+/g, '');
            let explicitPeriod = null;

            if (/(am|a)$/.test(working)) {
                explicitPeriod = 'am';
                working = working.replace(/(am|a)$/, '');
            } else if (/(pm|p)$/.test(working)) {
                explicitPeriod = 'pm';
                working = working.replace(/(pm|p)$/, '');
            }

            let hour = null;
            let minute = null;

            if (working.includes(':')) {
                const [hourPart, minutePartRaw] = working.split(':');
                hour = parseInt(hourPart, 10);
                const minutePart = (minutePartRaw || '').replace(/[^\d]/g, '').slice(0, 2);
                minute = minutePart ? parseInt(minutePart, 10) : 0;
            } else {
                const digits = working.replace(/[^\d]/g, '');
                if (!digits) {
                    return { ok: false, reason: 'no-digits' };
                }
                if (digits.length <= 2) {
                    hour = parseInt(digits, 10);
                    minute = 0;
                } else if (digits.length === 3) {
                    hour = parseInt(digits.slice(0, 1), 10);
                    minute = parseInt(digits.slice(1), 10);
                } else {
                    hour = parseInt(digits.slice(0, digits.length - 2), 10);
                    minute = parseInt(digits.slice(-2), 10);
                }
            }

            if (
                Number.isNaN(hour) ||
                Number.isNaN(minute) ||
                hour < 0 ||
                minute < 0 ||
                minute >= 60 ||
                hour > 24
            ) {
                return { ok: false, reason: 'invalid-range' };
            }

            if (hour === 24) {
                hour = 0;
                explicitPeriod = 'am';
            }

            const periodFromExplicit = explicitPeriod ? explicitPeriod : null;

            const minuteComponent = minute;
            const isExplicitMilitary =
                hour >= 13 ||
                (working.includes(':') && working.startsWith('0')) ||
                (working.length === 4 && parseInt(working.slice(0, 2), 10) >= 13) ||
                (working.length === 4 && parseInt(working.slice(0, 2), 10) === 0);

            const evaluateEndCandidate = (candidates, referenceMinutes) => {
                if (!candidates.length) return null;
                if (referenceMinutes == null) return candidates[0].hour24;

                const maxDuration = 12 * 60;
                let best = null;
                candidates.forEach((candidate) => {
                    const candidateMinutes = candidate.hour24 * 60 + minuteComponent;
                    let diff = candidateMinutes - referenceMinutes;
                    if (diff <= 0) diff += MINUTES_IN_DAY;
                    const withinWindow = diff > 0 && diff <= maxDuration;
                    if (withinWindow) {
                        if (!best || diff < best.diff) {
                            best = { hour24: candidate.hour24, diff };
                        }
                    }
                });
                if (best) return best.hour24;

                // fall back to closest positive duration when all candidates exceed 12 hours
               let fallback = null;
                candidates.forEach((candidate) => {
                    const candidateMinutes = candidate.hour24 * 60 + minuteComponent;
                    let diff = candidateMinutes - referenceMinutes;
                    if (diff <= 0) diff += MINUTES_IN_DAY;
                    if (!fallback || diff < fallback.diff) {
                        fallback = { hour24: candidate.hour24, diff };
                    }
                });
                return fallback ? fallback.hour24 : candidates[0].hour24;
            };

            let hour24 = 0;
            let resolvedPeriod = periodFromExplicit;

            if (mode === 'end') {
                const baseHour = hour % 12;
                const amHour = baseHour === 12 ? 0 : baseHour;
                const pmHour = baseHour === 12 ? 12 : baseHour + 12;
                const candidates = [];

                if (isExplicitMilitary) {
                    candidates.push({ hour24: hour % 24 });
                    resolvedPeriod = hour % 24 >= 12 ? 'pm' : 'am';
                } else if (resolvedPeriod === 'am') {
                    candidates.push({ hour24: amHour });
                } else if (resolvedPeriod === 'pm') {
                    candidates.push({ hour24: pmHour });
                } else {
                    if (!candidates.some((c) => c.hour24 === pmHour)) {
                        candidates.push({ hour24: pmHour });
                    }
                    if (!candidates.some((c) => c.hour24 === amHour)) {
                        candidates.push({ hour24: amHour });
                    }
                }

                const referenceMinutes = referenceStart ? timeStringToMinutes(referenceStart) : null;
                hour24 = evaluateEndCandidate(candidates, referenceMinutes);
                resolvedPeriod = hour24 >= 12 ? 'pm' : 'am';
            } else if (isExplicitMilitary) {
                hour24 = hour % 24;
                resolvedPeriod = hour24 >= 12 ? 'pm' : 'am';
            } else {
                if (!resolvedPeriod) {
                    if (mode === 'start') {
                        if (hour >= 10 && hour <= 11) {
                            resolvedPeriod = 'am';
                        } else {
                            resolvedPeriod = 'pm';
                        }
                    } else if (defaultPeriod) {
                        resolvedPeriod = defaultPeriod;
                    } else if (hour >= 10 && hour <= 11) {
                        resolvedPeriod = 'am';
                    } else {
                        resolvedPeriod = 'pm';
                    }
                }

                const baseHour = hour % 12;
                hour24 = baseHour;
                if (resolvedPeriod === 'pm' && hour24 < 12) {
                    hour24 += 12;
                }
                if (resolvedPeriod === 'am' && hour24 === 12) {
                    hour24 = 0;
                }
            }

            const normalized = `${hour24.toString().padStart(2, '0')}:${minuteComponent
                .toString()
                .padStart(2, '0')}`;
            return {
                ok: true,
                normalized,
                display: formatTimeDisplay(normalized),
                period: resolvedPeriod,
                raw: trimmed,
            };
        }

        function inferShiftTypeFromTimes(startTime, endTime) {
            if (!startTime) return '';
            const startMinutes = timeStringToMinutes(startTime);
            if (startMinutes == null) return '';
            const endMinutes = timeStringToMinutes(endTime);
            const duration = endMinutes != null ? normalizeMinutesDiff(startMinutes, endMinutes) : null;

            const dayStartMin = 10 * 60;
            const dayEndMax = 19 * 60 + 30; // 7:30 PM safety net
            const nightThreshold = 16 * 60; // 4:00 PM

            if (startMinutes >= nightThreshold || startMinutes < dayStartMin) {
                return 'night';
            }

            if (startMinutes >= dayStartMin && startMinutes <= 13 * 60) {
                if (!duration || duration <= 9 * 60) {
                    if (!endTime || timeStringToMinutes(endTime) <= dayEndMax) {
                        return 'day';
                    }
                }
            }

            if (startMinutes >= 13 * 60 && startMinutes <= nightThreshold) {
                if (endMinutes != null) {
                    const endWithinDay = endMinutes <= dayEndMax;
                    if (endWithinDay && (!duration || duration <= 8 * 60)) {
                        return 'day';
                    }
                }
            }

            return 'night';
        }

        function ensureCutSkeleton(type, parties, existingCuts) {
            const normalizedParties = parties || {};
            const baseCutSet =
                type === 'day'
                    ? new Set(['day', 'mid', 'night'])
                    : type === 'night'
                        ? new Set(['night', 'mid'])
                        : new Set(['day', 'mid', 'night']);

            baseCutSet.add('night'); // night cut is always available

            const requiredPartyCuts = Object.entries(normalizedParties)
                .filter(([, party]) => (party?.cutType || type || 'night') !== 'night')
                .map(([id]) => id);

            const requiredKeys = [...baseCutSet, ...requiredPartyCuts];
            const cuts = { ...(existingCuts || {}) };
            let changed = false;

            Object.keys(cuts).forEach((key) => {
                const isPartyCut = key.startsWith('party_');
                if (isPartyCut && !requiredPartyCuts.includes(key)) {
                    delete cuts[key];
                    changed = true;
                }
            });

            requiredKeys.forEach((key) => {
                if (!cuts[key]) {
                    changed = true;
                    cuts[key] = {
                        label: key.startsWith('party_')
                            ? normalizedParties?.[key]?.name || 'Party Cut'
                            : key.charAt(0).toUpperCase() + key.slice(1),
                        me: { tips: '', hours: '' },
                        total: { tips: '', hours: '' },
                        share: { pct: '', people: '', notes: '' },
                        status: 'pending',
                    };
                }
            });

            return changed ? cuts : existingCuts;
        }

        function sanitizeBartenderEntry(entry = {}) {
            return {
                id: entry.id || '',
                name: entry.name || '',
                start: entry.start || '',
                end: entry.end || '',
                actualStart: entry.actualStart || '',
                actualEnd: entry.actualEnd || '',
                location: entry.location || '',
                status: entry.status || 'tentative',
                notes: entry.notes || '',
                positions: Array.isArray(entry.positions) ? entry.positions : [],
                isManager: Boolean(entry.isManager),
                isSelf: Boolean(entry.isSelf),
            };
        }

        function sanitizeServerEntry(entry = {}) {
            return {
                id: entry.id || '',
                name: entry.name || '',
                start: entry.start || '',
                end: entry.end || '',
                actualStart: entry.actualStart || '',
                actualEnd: entry.actualEnd || '',
                order: entry.order || '',
                tipOut: entry.tipOut || '',
                notes: entry.notes || '',
            };
        }

        function sanitizeSupportEntry(entry = {}) {
            return {
                id: entry.id || '',
                name: entry.name || '',
                role: entry.role || 'Host',
                start: entry.start || '',
                end: entry.end || '',
                actualStart: entry.actualStart || '',
                actualEnd: entry.actualEnd || '',
                notes: entry.notes || '',
            };
        }

        function normalizeCrewData(raw) {
            const base = {
                bartenders: [],
                servers: [],
                support: [],
                estimates: {
                    fallbackEnd: '',
                    fallbackActualEnd: '',
                    notes: '',
                },
            };

            if (!raw) return base;

            const result = {
                bartenders: [],
                servers: [],
                support: [],
                estimates: { ...base.estimates, ...(raw.estimates || {}) },
            };

            if (Array.isArray(raw.bartenders)) {
                result.bartenders = raw.bartenders.map((entry) => sanitizeBartenderEntry(entry));
            } else if (raw.bartenders && typeof raw.bartenders === 'object') {
                Object.entries(raw.bartenders).forEach(([name, details]) => {
                    const detailArray = Array.isArray(details) ? details : [];
                    const schedule = detailArray[1] || '';
                    let start = '';
                    let end = '';
                    if (typeof schedule === 'string' && schedule.includes('-')) {
                        const [schedStart, schedEnd] = schedule.split('-').map((token) => token.trim());
                        start = schedStart || '';
                        end = schedEnd || '';
                    }
                    result.bartenders.push(
                        sanitizeBartenderEntry({
                            name,
                            location: detailArray[0] || '',
                            start,
                            end,
                            notes: detailArray.slice(2).join(' â€¢ '),
                        })
                    );
                });
            }

            if (Array.isArray(raw.servers)) {
                result.servers = raw.servers.map((entry) => sanitizeServerEntry(entry));
            } else if (raw.servers && typeof raw.servers === 'object') {
                Object.entries(raw.servers).forEach(([name, details]) => {
                    const detailArray = Array.isArray(details) ? details : [];
                    result.servers.push(
                        sanitizeServerEntry({
                            name,
                            start: detailArray[0] || '',
                            end: detailArray[1] || '',
                            notes: detailArray.slice(2).join(' â€¢ '),
                        })
                    );
                });
            }

            if (Array.isArray(raw.support)) {
                result.support = raw.support.map((entry) => sanitizeSupportEntry(entry));
            }

            return result;
        }

        function normalizeShiftPayload(shift) {
            if (!shift) return null;
            const cloned = JSON.parse(JSON.stringify(shift));
            cloned.coworkers = normalizeCrewData(cloned.coworkers);
            return cloned;
        }

        function upsertSelfCrew(data, directory) {
            if (!data) return data;
            const coworkers = data.coworkers || normalizeCrewData();
            const bartenders = coworkers.bartenders || [];
            const selfMember = directory.find((member) => member.isSelf);
            const expectedName = (selfMember?.name || 'Ian').trim().toLowerCase();

            let index = bartenders.findIndex(
                (entry) =>
                    entry.isSelf ||
                    (entry.name || '').trim().toLowerCase() === expectedName
            );

            const baseStart = data.time?.base?.start || '';
            const baseEnd = data.time?.base?.end || '';

            if (index === -1) {
                const next = JSON.parse(JSON.stringify(data));
                const entry = sanitizeBartenderEntry({
                    id: selfMember?.id || '',
                    name: selfMember?.name || 'Ian',
                    start: baseStart,
                    end: baseEnd,
                    actualStart: baseStart,
                    actualEnd: baseEnd,
                    status: 'confirmed',
                    positions: selfMember?.positions || [],
                    isManager: !!selfMember?.isManager,
                    isSelf: true,
                });
                next.coworkers = next.coworkers ? normalizeCrewData(next.coworkers) : normalizeCrewData();
                next.coworkers.bartenders = [entry, ...(next.coworkers.bartenders || [])];
                return next;
            }

            const candidate = bartenders[index];
            let changed = false;
            if (!candidate.isSelf) {
                changed = true;
            }
            if (selfMember) {
                if (!candidate.id && selfMember.id) changed = true;
                if ((!candidate.positions || candidate.positions.length === 0) && selfMember.positions?.length) changed = true;
                if (!candidate.isManager && selfMember.isManager) changed = true;
            }
            if (!candidate.start && baseStart) changed = true;
            if (!candidate.end && baseEnd) changed = true;
            if (!candidate.actualStart && baseStart) changed = true;
            if (!candidate.actualEnd && baseEnd) changed = true;

            if (!changed) return data;

            const next = JSON.parse(JSON.stringify(data));
            const target = next.coworkers.bartenders[index];
            target.isSelf = true;
            if (selfMember) {
                target.id = target.id || selfMember.id || '';
                if (!target.positions || target.positions.length === 0) {
                    target.positions = selfMember.positions || [];
                }
                if (selfMember.isManager) {
                    target.isManager = true;
                }
            }
            if (!target.start && baseStart) target.start = baseStart;
            if (!target.end && baseEnd) target.end = baseEnd;
            if (!target.actualStart && baseStart) target.actualStart = baseStart;
            if (!target.actualEnd && baseEnd) target.actualEnd = baseEnd;
            return next;
        }

        const BARTENDER_LOCATION_OPTIONS = [
            { value: '', label: 'â€”' },
            { value: 'Main', label: 'Main Bar' },
            { value: 'Main-Service', label: 'Main â€¢ Service' },
            { value: 'Main-Pit', label: 'Main â€¢ Pit' },
            { value: 'Main-Middle', label: 'Main â€¢ Middle' },
            { value: 'Deck', label: 'Deck' },
            { value: 'Upper', label: 'Upper Event' },
            { value: 'Support', label: 'Support' },
        ];

        const SUPPORT_ROLE_OPTIONS = ['Host', 'Busser', 'Doorman', 'Expo', 'Floor'];

        const BARTENDER_STATUS_OPTIONS = [
            { value: 'tentative', label: 'Tentative' },
            { value: 'confirmed', label: 'Confirmed' },
            { value: 'actual', label: 'Actual' },
        ];

        // Shift Form Component (Hybrid Dark UI)
        function ShiftForm({ shift, onSave, onCancel, coworkerDirectory = [] }) {
            const initialFormSnapshot = useMemo(
                () => deepMergeShift(DEFAULT_SHIFT_TEMPLATE, normalizeShiftPayload(shift)),
                [shift]
            );
            const [formData, setFormData] = useState(initialFormSnapshot);
            const [panelOpen, setPanelOpen] = useState({
                timings: false,
                cuts: false,
                coworkers: false,
                parties: false,
                enhancements: false,
                drinking: false,
            });
            const [timeDrafts, setTimeDrafts] = useState(() => buildInitialTimeDrafts(initialFormSnapshot));
            const [timeErrors, setTimeErrors] = useState({});
            const [shiftTypeMode, setShiftTypeMode] = useState(shift?.type ? 'manual' : 'auto');
            const [shiftTypeMenuOpen, setShiftTypeMenuOpen] = useState(false);
            const [expandedCuts, setExpandedCuts] = useState({});
            const [cutSnapshots, setCutSnapshots] = useState({});
            const [expandedParties, setExpandedParties] = useState({});
            const [partySnapshots, setPartySnapshots] = useState({});
            const shiftTypeDropdownRef = useRef(null);
            const bartenderDirectory = useMemo(() => {
                if (!coworkerDirectory.length) return [];
                return coworkerDirectory.filter((member) => {
                    const positions = member.positionsNormalized || [];
                    if (positions.length === 0) return true;
                    return positions.some((pos) =>
                        ['bartender', 'bar', 'barback'].some((keyword) => pos.includes(keyword))
                    );
                });
            }, [coworkerDirectory]);
            const serverDirectory = useMemo(() => {
                if (!coworkerDirectory.length) return [];
                return coworkerDirectory.filter((member) => {
                    const positions = member.positionsNormalized || [];
                    if (positions.length === 0) return true;
                    return positions.some((pos) => ['server', 'wait', 'food'].some((keyword) => pos.includes(keyword)));
                });
            }, [coworkerDirectory]);
            const supportDirectory = useMemo(() => {
                if (!coworkerDirectory.length) return [];
                return coworkerDirectory.filter((member) => {
                    const positions = member.positionsNormalized || [];
                    if (positions.length === 0) return true;
                    return positions.some((pos) =>
                        ['host', 'busser', 'door', 'expo', 'support'].some((keyword) => pos.includes(keyword))
                    );
                });
            }, [coworkerDirectory]);

            useEffect(() => {
                setFormData(initialFormSnapshot);
                setTimeDrafts(buildInitialTimeDrafts(initialFormSnapshot));
                setTimeErrors({});
                setShiftTypeMode(initialFormSnapshot.type ? 'manual' : 'auto');
                setShiftTypeMenuOpen(false);
                setExpandedCuts({});
                setCutSnapshots({});
                setExpandedParties({});
                setPartySnapshots({});
            }, [initialFormSnapshot]);

            useEffect(() => {
                if (!coworkerDirectory.length) return;
                setFormData((prev) => {
                    const updated = upsertSelfCrew(prev, coworkerDirectory);
                    if (updated === prev) return prev;
                    setTimeDrafts(buildInitialTimeDrafts(updated));
                    return updated;
                });
            }, [coworkerDirectory, formData.time?.base?.start, formData.time?.base?.end]);

            useEffect(() => {
                if (!shiftTypeMenuOpen) return undefined;
                const handleClickAway = (event) => {
                    if (shiftTypeDropdownRef.current && !shiftTypeDropdownRef.current.contains(event.target)) {
                        setShiftTypeMenuOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickAway);
                return () => document.removeEventListener('mousedown', handleClickAway);
            }, [shiftTypeMenuOpen]);

            useEffect(() => {
                setFormData((prev) => {
                    const nextCuts = ensureCutSkeleton(prev.type, prev.parties, prev.cuts);
                    if (nextCuts === prev.cuts) return prev;
                    return { ...prev, cuts: nextCuts };
                });
            }, [formData.type, Object.keys(formData.parties || {}).join('|')]);

            const togglePanel = (panel) => {
                setPanelOpen((prev) => ({ ...prev, [panel]: !prev[panel] }));
            };

            const updateFormPath = (path, value) => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    setNestedValue(next, path, value);
                    return next;
                });
            };

            const mapFormPathToDraft = (path) => {
                if (path.startsWith('time.base.')) {
                    return path.replace('time.base.', 'base.');
                }
                if (path.startsWith('time.')) {
                    const [, bucket, key] = path.split('.');
                    return `buckets.${bucket}.${key}`;
                }
                if (path.startsWith('parties.') && path.includes('.time.')) {
                    return path.replace(/parties\.([^.]+)\.time\./, 'parties.$1.');
                }
                if (path.startsWith('wage.clock.')) {
                    return path.replace('wage.clock.', 'wage.');
                }
                if (path.startsWith('coworkers.bartenders.')) {
                    return path.replace('coworkers.', 'crew.');
                }
                if (path.startsWith('coworkers.servers.')) {
                    return path.replace('coworkers.', 'crew.');
                }
                if (path.startsWith('coworkers.support.')) {
                    return path.replace('coworkers.', 'crew.');
                }
                if (path.startsWith('coworkers.estimates.')) {
                    return path.replace('coworkers.', 'crew.');
                }
                return path;
            };

            const getTimeDraftValue = (formPath) => {
                const draftPath = mapFormPathToDraft(formPath);
                const draftValue = getNestedValue(timeDrafts, draftPath);
                if (draftValue !== undefined) {
                    return draftValue ?? '';
                }
                const persisted = getNestedValue(formData, formPath);
                return formatTimeDisplay(persisted);
            };

            const handleTimeDraftChange = (formPath, value) => {
                const draftPath = mapFormPathToDraft(formPath);
                setTimeDrafts((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    setNestedValue(next, draftPath, value);
                    return next;
                });
            };

            const commitTimeValue = (formPath, rawValue, options = {}) => {
                const draftPath = mapFormPathToDraft(formPath);
                const parsed = parseFlexibleTime(rawValue, options);
                if (!parsed.ok) {
                    setTimeErrors((prev) => ({
                        ...prev,
                        [formPath]: 'Unable to read time',
                    }));
                    setTimeDrafts((prev) => {
                        const next = JSON.parse(JSON.stringify(prev));
                        setNestedValue(next, draftPath, rawValue || '');
                        return next;
                    });
                    return null;
                }

                setTimeErrors((prev) => {
                    if (!prev[formPath]) return prev;
                    const next = { ...prev };
                    delete next[formPath];
                    return next;
                });

                setTimeDrafts((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    setNestedValue(next, draftPath, parsed.display || '');
                    return next;
                });

                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    setNestedValue(next, formPath, parsed.normalized);

                    if (formPath.startsWith('time.base.')) {
                        const start = formPath === 'time.base.start' ? parsed.normalized : next.time.base.start;
                        const end = formPath === 'time.base.end' ? parsed.normalized : next.time.base.end;
                        if (start && end) {
                            const hours = calculateHoursBetween(start, end);
                            next.time.base.hours = hours;
                            next.wage.hours = hours;
                            const wageRate = parseFloat(next.wage.base) || 0;
                            next.wage.total = parseFloat((wageRate * hours).toFixed(2));
                            next.summary.hours = hours;
                        }
                    }

                    if (formPath.startsWith('wage.clock.')) {
                        next.wage.clock = next.wage.clock || { start: '', end: '' };
                    }

                    const partyMatch = formPath.match(/^parties\.([^.]+)\.time\.(start|end)$/);
                    if (partyMatch) {
                        const [, partyId] = partyMatch;
                        const party = next.parties?.[partyId];
                        if (party) {
                            const start = party.time?.start;
                            const end = party.time?.end;
                            if (start && end) {
                                party.time.duration = calculateHoursBetween(start, end);
                            } else if (party.time) {
                                delete party.time.duration;
                            }
                        }
                    }

                    return next;
                });

                return parsed;
            };

            const parseAmount = (value, fallback = 0) => {
                if (value === '' || value === null || value === undefined) return fallback;
                const numeric = typeof value === 'number' ? value : parseFloat(value);
                if (Number.isNaN(numeric)) return fallback;
                return numeric;
            };

            const matchCoworkerByName = (value) => {
                if (!value) return null;
                const normalized = value.trim().toLowerCase();
                if (!normalized) return null;
                return (
                    coworkerDirectory.find((member) => {
                        const nameMatch = member.name?.trim().toLowerCase() === normalized;
                        if (nameMatch) return true;
                        const full = [member.firstName, member.lastName].filter(Boolean).join(' ').trim().toLowerCase();
                        if (full && full === normalized) return true;
                        if (member.firstName && member.firstName.trim().toLowerCase() === normalized) return true;
                        return false;
                    }) || null
                );
            };

            const addBartenderRow = (defaults = {}) => {
                let snapshot = null;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers = next.coworkers ? normalizeCrewData(next.coworkers) : normalizeCrewData();
                    next.coworkers.bartenders = next.coworkers.bartenders || [];
                    next.coworkers.bartenders.push(sanitizeBartenderEntry(defaults));
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const removeBartenderRow = (index) => {
                let snapshot = null;
                setFormData((prev) => {
                    const list = prev.coworkers?.bartenders || [];
                    const target = list[index];
                    if (!target || target.isSelf) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers.bartenders.splice(index, 1);
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const handleBartenderNameChange = (index, value) => {
                setFormData((prev) => {
                    const list = prev.coworkers?.bartenders || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    const target = next.coworkers.bartenders[index];
                    target.name = value;
                    const match = matchCoworkerByName(value);
                    if (match) {
                        target.id = match.id || target.id;
                        target.positions = match.positions || target.positions || [];
                        target.isManager = target.isManager || match.isManager;
                        if (match.isSelf) {
                            target.isSelf = true;
                        }
                    } else if (!target.isSelf) {
                        target.id = '';
                        target.isManager = false;
                    }
                    return next;
                });
            };

            const syncBartenderActualTimes = (index) => {
                let snapshot = null;
                setFormData((prev) => {
                    const list = prev.coworkers?.bartenders || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    const target = next.coworkers.bartenders[index];
                    if (target.start && !target.actualStart) {
                        target.actualStart = target.start;
                    }
                    if (target.end && !target.actualEnd) {
                        target.actualEnd = target.end;
                    }
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const addServerRow = () => {
                let snapshot = null;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers = next.coworkers ? normalizeCrewData(next.coworkers) : normalizeCrewData();
                    next.coworkers.servers = next.coworkers.servers || [];
                    next.coworkers.servers.push(sanitizeServerEntry());
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const removeServerRow = (index) => {
                let snapshot = null;
                setFormData((prev) => {
                    const list = prev.coworkers?.servers || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers.servers.splice(index, 1);
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const handleServerNameChange = (index, value) => {
                setFormData((prev) => {
                    const list = prev.coworkers?.servers || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    const target = next.coworkers.servers[index];
                    target.name = value;
                    const match = matchCoworkerByName(value);
                    if (match) {
                        target.id = match.id || target.id;
                    } else {
                        target.id = '';
                    }
                    return next;
                });
            };

            const addSupportRow = () => {
                let snapshot = null;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers = next.coworkers ? normalizeCrewData(next.coworkers) : normalizeCrewData();
                    next.coworkers.support = next.coworkers.support || [];
                    next.coworkers.support.push(sanitizeSupportEntry());
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const removeSupportRow = (index) => {
                let snapshot = null;
                setFormData((prev) => {
                    const list = prev.coworkers?.support || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    next.coworkers.support.splice(index, 1);
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                }
            };

            const handleSupportNameChange = (index, value) => {
                setFormData((prev) => {
                    const list = prev.coworkers?.support || [];
                    if (!list[index]) return prev;
                    const next = JSON.parse(JSON.stringify(prev));
                    const target = next.coworkers.support[index];
                    target.name = value;
                    const match = matchCoworkerByName(value);
                    if (match) {
                        target.id = match.id || target.id;
                    } else {
                        target.id = '';
                    }
                    return next;
                });
            };

            const applyFallbackToBartenders = (field) => {
                const fallback = formData.coworkers?.estimates?.[field];
                if (!fallback) return;
                let snapshot = null;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    const list = next.coworkers?.bartenders || [];
                    list.forEach((entry) => {
                        if (field === 'fallbackEnd' && !entry.end) {
                            entry.end = fallback;
                        }
                        if (field === 'fallbackActualEnd' && !entry.actualEnd) {
                            entry.actualEnd = fallback;
                        }
                    });
                    snapshot = next;
                    return next;
                });
                if (snapshot) {
                    setTimeDrafts(buildInitialTimeDrafts(snapshot));
                    setTimeErrors((prev) => {
                        if (!prev || Object.keys(prev).length === 0) return prev;
                        const nextErrors = { ...prev };
                        (snapshot.coworkers?.bartenders || []).forEach((_, idx) => {
                            if (field === 'fallbackEnd') {
                                delete nextErrors[`coworkers.bartenders.${idx}.end`];
                            }
                            if (field === 'fallbackActualEnd') {
                                delete nextErrors[`coworkers.bartenders.${idx}.actualEnd`];
                            }
                        });
                        return nextErrors;
                    });
                }
            };

            useEffect(() => {
                if (shiftTypeMode !== 'auto') return;
                const start = formData.time?.base?.start;
                if (!start) return;
                const inferred = inferShiftTypeFromTimes(start, formData.time?.base?.end);
                if (inferred && inferred !== formData.type) {
                    setFormData((prev) => ({ ...prev, type: inferred }));
                }
            }, [formData.time?.base?.start, formData.time?.base?.end, shiftTypeMode]);

            const handleTipsChange = (value) => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.tips._total = value;
                    next.earnings.tips = parseAmount(value);
                    return next;
                });
            };

            const handleAddParty = () => {
                const partyId = `party_${(formData.date || '').replace(/-/g, '') || 'temp'}_${Date.now().toString(36)}`;
                const newParty = {
                    id: partyId,
                    name: 'New Party',
                    type: '',
                    cutType: formData.type === 'day' ? 'day' : 'night',
                    location: '',
                    time: { start: '', end: '', duration: null },
                    size: '',
                    packages: { drink: '', food: '' },
                    tips: {},
                    workers: { primary: '', supplement: [] },
                    notes: '',
                };

                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.parties = next.parties || {};
                    next.parties[partyId] = newParty;
                    return next;
                });

                setTimeDrafts((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.parties = next.parties || {};
                    next.parties[partyId] = { start: '', end: '' };
                    return next;
                });

                setPartySnapshots((prev) => ({ ...prev, [partyId]: null }));
                setExpandedParties((prev) => ({ ...prev, [partyId]: true }));
                setPanelOpen((prev) => ({ ...prev, parties: true, cuts: true }));
            };

            const handleAddCut = () => {
                const cutKey = `custom_${Date.now().toString(36)}`;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.cuts = next.cuts || {};
                    next.cuts[cutKey] = {
                        label: 'Custom Cut',
                        me: { tips: '', hours: '' },
                        total: { tips: '', hours: '' },
                        share: { pct: '', people: '', notes: '' },
                        status: 'pending',
                    };
                    return next;
                });
                setCutSnapshots((prev) => ({ ...prev, [cutKey]: null }));
                setExpandedCuts((prev) => ({ ...prev, [cutKey]: true }));
                setPanelOpen((prev) => ({ ...prev, cuts: true }));
            };

            const togglePartyDetails = (partyId) => {
                setExpandedParties((prev) => {
                    const isOpen = !!prev[partyId];
                    if (!isOpen) {
                        setPartySnapshots((snapshots) => {
                            if (Object.prototype.hasOwnProperty.call(snapshots, partyId)) return snapshots;
                            const original = formData.parties?.[partyId]
                                ? JSON.parse(JSON.stringify(formData.parties[partyId]))
                                : null;
                            return { ...snapshots, [partyId]: original };
                        });
                    }
                    return { ...prev, [partyId]: !isOpen };
                });
            };

            const savePartySection = (partyId) => {
                setPartySnapshots((prev) => {
                    const next = { ...prev };
                    delete next[partyId];
                    return next;
                });
                setExpandedParties((prev) => ({ ...prev, [partyId]: false }));
            };

            const cancelPartySection = (partyId) => {
                const snapshot = partySnapshots[partyId];
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (snapshot === null) {
                        if (next.parties) {
                            delete next.parties[partyId];
                        }
                    } else if (snapshot) {
                        next.parties = next.parties || {};
                        next.parties[partyId] = JSON.parse(JSON.stringify(snapshot));
                    }
                    return next;
                });
                setTimeDrafts((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.parties = next.parties || {};
                    if (snapshot === null) {
                        if (next.parties[partyId]) {
                            delete next.parties[partyId];
                        }
                    } else {
                        next.parties[partyId] = {
                            start: formatTimeDisplay(snapshot?.time?.start),
                            end: formatTimeDisplay(snapshot?.time?.end),
                        };
                    }
                    return next;
                });
                setPartySnapshots((prev) => {
                    const next = { ...prev };
                    delete next[partyId];
                    return next;
                });
                setExpandedParties((prev) => ({ ...prev, [partyId]: false }));
                setTimeErrors((prev) => {
                    const next = { ...prev };
                    delete next[`parties.${partyId}.time.start`];
                    delete next[`parties.${partyId}.time.end`];
                    return next;
                });
            };

            const toggleCutDetails = (cutKey) => {
                setExpandedCuts((prev) => {
                    const isOpen = !!prev[cutKey];
                    if (!isOpen) {
                        setCutSnapshots((snapshots) => {
                            if (Object.prototype.hasOwnProperty.call(snapshots, cutKey)) return snapshots;
                            const original = formData.cuts?.[cutKey]
                                ? JSON.parse(JSON.stringify(formData.cuts[cutKey]))
                                : null;
                            return { ...snapshots, [cutKey]: original };
                        });
                    }
                    return { ...prev, [cutKey]: !isOpen };
                });
            };

            const saveCutSection = (cutKey) => {
                setCutSnapshots((prev) => {
                    const next = { ...prev };
                    delete next[cutKey];
                    return next;
                });
                setExpandedCuts((prev) => ({ ...prev, [cutKey]: false }));
            };

            const cancelCutSection = (cutKey) => {
                const snapshot = cutSnapshots[cutKey];
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (snapshot === null) {
                        if (next.cuts) {
                            delete next.cuts[cutKey];
                        }
                    } else if (snapshot) {
                        next.cuts = next.cuts || {};
                        next.cuts[cutKey] = JSON.parse(JSON.stringify(snapshot));
                    }
                    return next;
                });
                setCutSnapshots((prev) => {
                    const next = { ...prev };
                    delete next[cutKey];
                    return next;
                });
                setExpandedCuts((prev) => ({ ...prev, [cutKey]: false }));
            };

            const deleteCut = (cutKey) => {
                const baseKeys = new Set(['day', 'mid', 'night']);
                if (baseKeys.has(cutKey)) return;
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (next.cuts) {
                        delete next.cuts[cutKey];
                    }
                    return next;
                });
                setCutSnapshots((prev) => {
                    const next = { ...prev };
                    delete next[cutKey];
                    return next;
                });
                setExpandedCuts((prev) => {
                    const next = { ...prev };
                    delete next[cutKey];
                    return next;
                });
            };

            const handleDeleteParty = (partyId) => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (next.parties) {
                        delete next.parties[partyId];
                    }
                    return next;
                });
                setTimeDrafts((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (next.parties && next.parties[partyId]) {
                        delete next.parties[partyId];
                    }
                    return next;
                });
                setPartySnapshots((prev) => {
                    const next = { ...prev };
                    delete next[partyId];
                    return next;
                });
                setExpandedParties((prev) => {
                    const next = { ...prev };
                    delete next[partyId];
                    return next;
                });
                setTimeErrors((prev) => {
                    const next = { ...prev };
                    delete next[`parties.${partyId}.time.start`];
                    delete next[`parties.${partyId}.time.end`];
                    return next;
                });
            };

            const selectShiftType = (nextType) => {
                if (nextType === 'auto') {
                    setShiftTypeMode('auto');
                    const inferred = inferShiftTypeFromTimes(formData.time?.base?.start, formData.time?.base?.end);
                    setFormData((prev) => ({ ...prev, type: inferred || '' }));
                } else {
                    setShiftTypeMode('manual');
                    setFormData((prev) => ({ ...prev, type: nextType }));
                }
                setShiftTypeMenuOpen(false);
            };

            const removeCoworker = (role, name) => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    if (next.coworkers?.[role]) {
                        delete next.coworkers[role][name];
                    }
                    return next;
                });
            };

            const shiftTypeLabel = useMemo(() => {
                if (shiftTypeMode === 'auto') {
                    if (!formData.type) return 'Auto Â· Pending';
                    const meta = SHIFT_TYPE_META[formData.type];
                    return meta ? `Auto Â· ${meta.label}` : 'Auto';
                }
                if (formData.type) {
                    const meta = SHIFT_TYPE_META[formData.type];
                    return meta ? meta.label : 'Shift';
                }
                return 'Select shift type';
            }, [shiftTypeMode, formData.type]);

            const handleAddSwindleMovement = () => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.swindle.movements = next.swindle.movements || [];
                    next.swindle.movements.push({ from: '', to: '', amount: '', note: '' });
                    return next;
                });
            };

            const handleAddConsideration = () => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.consideration.items = next.consideration.items || [];
                    next.consideration.items.push({ from: '', amount: '', reason: '' });
                    return next;
                });
            };

            const handleAddDrinkingItem = () => {
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    next.drinking.items = next.drinking.items || [];
                    next.drinking.items.push({ name: '', code: '', abv: '', oz: '', sbe: '', type: '', quantity: 1 });
                    return next;
                });
                setPanelOpen((prev) => ({ ...prev, drinking: true }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                setFormData((prev) => {
                    const next = JSON.parse(JSON.stringify(prev));
                    const hours = next.time.base.hours || calculateHoursBetween(next.time.base.start, next.time.base.end);
                    const tipsTotal = parseAmount(next.tips._total);
                    const wageBase = parseAmount(next.wage.base);
                    const wageHours = next.wage.hours !== undefined && next.wage.hours !== '' ? parseAmount(next.wage.hours) : hours || 0;
                    const wageTotal = next.wage.total !== undefined && next.wage.total !== '' ? parseAmount(next.wage.total) : parseFloat((wageBase * wageHours).toFixed(2));
                    const overtime = parseAmount(next.earnings.overtime || next.overtime);
                    const chump = parseAmount(next.earnings.chump);
                    const consideration = parseAmount(next.earnings.consideration || next.consideration.net);
                    const swindle = parseAmount(next.earnings.swindle || next.swindle.total);

                    const totalEarnings = parseFloat((tipsTotal + wageTotal + overtime + chump + consideration + swindle).toFixed(2));
                    const hourlyRate = hours > 0 ? parseFloat((totalEarnings / hours).toFixed(2)) : 0;

                    next.time.base.hours = hours;
                    next.wage.hours = next.wage.hours !== undefined && next.wage.hours !== '' ? next.wage.hours : hours;
                    next.wage.total = wageTotal;
                    next.summary.hours = hours;

                    next.earnings = {
                        tips: tipsTotal,
                        wage: wageTotal,
                        overtime,
                        chump,
                        consideration,
                        swindle,
                        total: totalEarnings,
                    };

                    next.summary.earnings = totalEarnings;
                    next.summary.hourly = hourlyRate;
                    next.summary.tips.actual = {
                        total: tipsTotal,
                        perHour: hours > 0 ? parseFloat((tipsTotal / hours).toFixed(2)) : 0,
                    };

                    const payload = {
                        ...next,
                        id: next.id || `shift_${(next.date || '').replace(/-/g, '')}`,
                    };
                    onSave(payload);
                    setPartySnapshots({});
                    setCutSnapshots({});
                    setExpandedParties({});
                    setExpandedCuts({});
                    return next;
                });
            };

            const calculatedHours = formData.time.base.hours || calculateHoursBetween(formData.time.base.start, formData.time.base.end);
            const tipsTotalValue = parseAmount(formData.tips._total);
            const wageBaseValue = parseAmount(formData.wage.base);
            const wageHoursValue =
                formData.wage.hours !== undefined && formData.wage.hours !== ''
                    ? parseAmount(formData.wage.hours)
                    : calculatedHours || 0;
            const wageTotal =
                formData.wage.total !== undefined && formData.wage.total !== ''
                    ? parseAmount(formData.wage.total)
                    : parseFloat((wageBaseValue * wageHoursValue).toFixed(2));
            const overtimeTotal = parseAmount(formData.earnings.overtime);
            const chumpTotal = parseAmount(formData.earnings.chump);
            const considerationTotal = parseAmount(formData.earnings.consideration ?? formData.consideration?.net);
            const swindleTotal = parseAmount(formData.earnings.swindle ?? formData.swindle?.total);
            const displayedEarnings =
                formData.earnings.total !== undefined && formData.earnings.total !== ''
                    ? parseAmount(formData.earnings.total)
                    : parseFloat((tipsTotalValue + wageTotal + overtimeTotal + chumpTotal + considerationTotal + swindleTotal).toFixed(2));
            const displayedHourly =
                formData.summary.hourly !== undefined && formData.summary.hourly !== ''
                    ? parseAmount(formData.summary.hourly)
                    : calculatedHours > 0
                        ? parseFloat((displayedEarnings / calculatedHours).toFixed(2))
                        : 0;
            const tipsPerHour =
                formData.summary.tips?.actual?.perHour !== undefined && formData.summary.tips.actual.perHour !== ''
                    ? parseAmount(formData.summary.tips.actual.perHour)
                    : calculatedHours > 0
                        ? parseFloat((tipsTotalValue / calculatedHours).toFixed(2))
                        : 0;
            const wageClockHours =
                formData.wage?.clock?.start && formData.wage?.clock?.end
                    ? calculateHoursBetween(formData.wage.clock.start, formData.wage.clock.end)
                    : null;

            const shiftTypeMeta = SHIFT_TYPE_META[formData.type] || SHIFT_TYPE_META.default;
            const headerIcon = shiftTypeMeta.icon || (shiftTypeMode === 'auto' ? 'fa-circle-half-stroke' : 'fa-circle-question');
            const headerGradient = 'from-slate-950 via-slate-900 to-slate-950';
            const partyCount = Object.keys(formData.parties || {}).length;
            const bartenderCount = (formData.coworkers?.bartenders || []).length;
            const serverCount = (formData.coworkers?.servers || []).length;
            const supportCount = (formData.coworkers?.support || []).length;
            const coworkerCount = bartenderCount + serverCount + supportCount;
            const chumpStatus = formData.chump?.played ? (formData.chump.winner ? 'recorded' : 'pending') : 'not-played';

            const quickPanels = [
                {
                    key: 'cuts',
                    icon: 'fa-chart-pie',
                    label: 'Cuts',
                    metric: Object.keys(formData.cuts || {}).length,
                    status: Object.values(formData.cuts || {}).some((cut) => cut?.me?.tips) ? 'ok' : 'pending',
                },
                {
                    key: 'parties',
                    icon: 'fa-glass-cheers',
                    label: 'Parties',
                    metric: partyCount,
                    status: partyCount > 0 ? 'ok' : 'none',
                },
                {
                    key: 'coworkers',
                    icon: 'fa-people-group',
                    label: 'Crew',
                    metric: coworkerCount,
                    status: coworkerCount > 0 ? 'ok' : 'pending',
                },
                {
                    key: 'enhancements',
                    icon: 'fa-sliders',
                    label: 'Enhancements',
                    metric: '',
                    status: (formData.overtime || formData.consideration.items?.length || formData.swindle.movements?.length) ? 'ok' : 'none',
                },
                {
                    key: 'drinking',
                    icon: 'fa-wine-glass',
                    label: 'Drinks',
                    metric: formData.drinking?.items?.length || 0,
                    status: formData.drinking?.items?.length ? 'ok' : 'none',
                },
            ];

            const statusBadgeClass = (status) => {
                switch (status) {
                    case 'ok':
                        return 'bg-emerald-400/80 shadow-emerald-300/30';
                    case 'pending':
                        return 'bg-amber-400/80 shadow-amber-300/30';
                    case 'none':
                    default:
                        return 'bg-slate-600/70 shadow-slate-500/20';
                }
            };

            return (
                <div className="max-w-5xl mx-auto">
                    <div className="glass rounded-3xl shadow-2xl overflow-hidden animate-slide-in border border-slate-800/40">
                        <div className={`bg-gradient-to-r ${headerGradient} px-8 py-6 flex items-center justify-between`}>
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-white text-2xl">
                                    <i className={`fas ${headerIcon}`}></i>
                                </div>
                                <div>
                                    <p className="text-xs uppercase tracking-widest text-white/70">Shift Worksheet</p>
                                    <h2 className="text-3xl font-semibold text-white">{shift ? 'Edit Shift' : 'Create Shift'}</h2>
                                    <div className="mt-2 flex flex-wrap items-center gap-2">
                                        <span className="badge-pill bg-white/15 text-white border border-white/20">
                                            {shiftTypeMode === 'auto' ? 'Auto Mode' : 'Manual Mode'}
                                        </span>
                                        {formData.type && (
                                            <span className="badge-pill bg-cyan-500/20 text-cyan-100 border border-cyan-400/40">
                                                {shiftTypeMeta.label}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {formData.meta?.tipsPending && (
                                    <span className="badge-pill bg-amber-400/30 text-amber-200 border border-amber-300/30">
                                        Tips Pending
                                    </span>
                                )}
                                <button
                                    onClick={onCancel}
                                    type="button"
                                    className="icon-button text-white/80 hover:text-white p-2 rounded-lg hover:bg-white/10"
                                >
                                    <i className="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="px-8 py-8 space-y-8">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2">
                                    <label className="text-sm uppercase tracking-wide text-slate-400">Date</label>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => updateFormPath('date', e.target.value)}
                                        className="mt-2 w-full px-6 py-4 bg-slate-900/60 border border-slate-700 rounded-2xl text-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        required
                                    />
                                </div>
                                <div ref={shiftTypeDropdownRef}>
                                    <label className="text-sm uppercase tracking-wide text-slate-400">Shift Type</label>
                                    <div className="mt-2 relative">
                                        <button
                                            type="button"
                                            onClick={() => setShiftTypeMenuOpen((prev) => !prev)}
                                            className="w-full px-5 py-4 bg-slate-900/60 border border-slate-700 rounded-2xl text-sm font-medium flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        >
                                            <span>{shiftTypeLabel}</span>
                                            <i className={`fas fa-chevron-${shiftTypeMenuOpen ? 'up' : 'down'} text-slate-500`}></i>
                                        </button>
                                        {shiftTypeMenuOpen && (
                                            <div className="absolute z-20 mt-2 w-full bg-slate-900/95 border border-slate-700 rounded-xl shadow-lg backdrop-blur space-y-1 py-2">
                                                <button
                                                    type="button"
                                                    onClick={() => selectShiftType('auto')}
                                                    className={`w-full text-left px-4 py-2 text-sm hover:bg-slate-800 ${
                                                        shiftTypeMode === 'auto' ? 'text-cyan-200' : 'text-slate-200'
                                                    }`}
                                                >
                                                    Auto (based on times)
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => selectShiftType('day')}
                                                    className={`w-full text-left px-4 py-2 text-sm hover:bg-slate-800 ${
                                                        shiftTypeMode === 'manual' && formData.type === 'day' ? 'text-cyan-200' : 'text-slate-200'
                                                    }`}
                                                >
                                                    Day Shift
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => selectShiftType('night')}
                                                    className={`w-full text-left px-4 py-2 text-sm hover:bg-slate-800 ${
                                                        shiftTypeMode === 'manual' && formData.type === 'night' ? 'text-cyan-200' : 'text-slate-200'
                                                    }`}
                                                >
                                                    Night Shift
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => selectShiftType('double')}
                                                    className={`w-full text-left px-4 py-2 text-sm hover:bg-slate-800 ${
                                                        shiftTypeMode === 'manual' && formData.type === 'double' ? 'text-cyan-200' : 'text-slate-200'
                                                    }`}
                                                >
                                                    Double Shift
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="md:col-span-1">
                                    <label className="text-sm uppercase tracking-wide text-slate-400 flex items-center gap-2">
                                        Start Time
                                        <button type="button" onClick={() => togglePanel('timings')} className="text-slate-500 hover:text-cyan-300">
                                            <i className="fas fa-clock"></i>
                                        </button>
                                    </label>
                            <div className="mt-2 space-y-1">
                                <input
                                    type="text"
                                    inputMode="numeric"
                                    value={getTimeDraftValue('time.base.start')}
                                    onChange={(e) => handleTimeDraftChange('time.base.start', e.target.value)}
                                    onBlur={(e) => commitTimeValue('time.base.start', e.target.value, { mode: 'start' })}
                                    onFocus={(e) => e.target.select()}
                                    className="w-full px-5 py-5 bg-slate-900/60 border border-slate-700 rounded-2xl text-2xl tracking-wide focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    placeholder="e.g. 10"
                                    required
                                />
                                {timeErrors['time.base.start'] && (
                                    <p className="text-xs text-amber-400">{timeErrors['time.base.start']}</p>
                                )}
                            </div>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-sm uppercase tracking-wide text-slate-400 flex items-center gap-2">
                                        End Time
                                        <button type="button" onClick={() => togglePanel('timings')} className="text-slate-500 hover:text-cyan-300">
                                            <i className="fas fa-business-time"></i>
                                        </button>
                                    </label>
                            <div className="mt-2 space-y-1">
                                <input
                                    type="text"
                                    inputMode="numeric"
                                    value={getTimeDraftValue('time.base.end')}
                                    onChange={(e) => handleTimeDraftChange('time.base.end', e.target.value)}
                                    onBlur={(e) =>
                                        commitTimeValue('time.base.end', e.target.value, {
                                            mode: 'end',
                                            referenceStart: formData.time?.base?.start,
                                        })
                                    }
                                    onFocus={(e) => e.target.select()}
                                    className="w-full px-5 py-5 bg-slate-900/60 border border-slate-700 rounded-2xl text-2xl tracking-wide focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    placeholder="e.g. 630"
                                    required
                                />
                                {timeErrors['time.base.end'] && (
                                    <p className="text-xs text-amber-400">{timeErrors['time.base.end']}</p>
                                )}
                            </div>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-sm uppercase tracking-wide text-slate-400 flex items-center gap-2">
                                        <span>Tips</span>
                                        <button
                                            type="button"
                                            onClick={() => updateFormPath('meta.tipsPending', !formData.meta?.tipsPending)}
                                            className={`text-xs px-2 py-1 rounded-lg border ${formData.meta?.tipsPending ? 'border-amber-400 text-amber-200 bg-amber-400/10' : 'border-slate-600 text-slate-400 hover:border-slate-400'}`}
                                        >
                                            {formData.meta?.tipsPending ? 'Mark Received' : 'Mark Pending'}
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('cuts')}
                                            className="icon-button text-slate-500 hover:text-cyan-300"
                                            title="Open cuts"
                                        >
                                            <i className="fas fa-layer-group"></i>
                                        </button>
                                    </label>
                                    <div className="mt-2 relative">
                                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-2xl">$</span>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.tips._total}
                                            onChange={(e) => handleTipsChange(e.target.value)}
                                            className="w-full pl-12 pr-4 py-5 bg-slate-900/60 border border-slate-700 rounded-2xl text-3xl font-semibold focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                            placeholder="0.00"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
                                <div className="glass rounded-2xl p-4 border border-slate-800/60">
                                    <p className="text-xs uppercase tracking-widest text-slate-500">Total Earnings</p>
                                    <p className="mt-2 text-3xl font-semibold text-cyan-300">${displayedEarnings.toFixed(2)}</p>
                                    <p className="text-xs text-slate-500 mt-1">Includes tips, wage, adjustments</p>
                                </div>
                                <div className="glass rounded-2xl p-4 border border-slate-800/60">
                                    <p className="text-xs uppercase tracking-widest text-slate-500">Hours</p>
                                    <p className="mt-2 text-3xl font-semibold text-emerald-300">{(calculatedHours || 0).toFixed(1)}h</p>
                                    <p className="text-xs text-slate-500 mt-1">{formData.time.base.start || '--:--'} &rarr; {formData.time.base.end || '--:--'}</p>
                                </div>
                                <div className="glass rounded-2xl p-4 border border-slate-800/60">
                                    <p className="text-xs uppercase tracking-widest text-slate-500">Hourly</p>
                                    <p className="mt-2 text-3xl font-semibold text-indigo-300">${displayedHourly.toFixed(2)}</p>
                                    <p className="text-xs text-slate-500 mt-1">Tips/hr ${tipsPerHour.toFixed(2)}</p>
                                </div>
                                <div className="glass rounded-2xl p-4 border border-slate-800/60 flex flex-col gap-3">
                                    <div className="flex items-center gap-2">
                                        <i className="fas fa-dice text-sm text-slate-400"></i>
                                        <span className="text-xs uppercase tracking-widest text-slate-500">Chump</span>
                                        <span className={`badge-pill ${
                                            chumpStatus === 'recorded'
                                                ? 'bg-emerald-400/20 text-emerald-200 border border-emerald-400/40'
                                                : chumpStatus === 'pending'
                                                    ? 'bg-amber-400/20 text-amber-200 border border-amber-400/40'
                                                    : 'bg-slate-800 text-slate-400 border border-slate-700'
                                        }`}>
                                            {chumpStatus === 'recorded' ? 'Logged' : chumpStatus === 'pending' ? 'Result Pending' : 'Not Played'}
                                        </span>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={() => togglePanel('enhancements')}
                                        className="text-sm text-cyan-200 hover:text-white flex items-center gap-2"
                                    >
                                        Manage Enhancements
                                        <i className="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <div className="flex flex-wrap gap-3">
                                {quickPanels.map((panel) => (
                                    <button
                                        key={panel.key}
                                        type="button"
                                        onClick={() => togglePanel(panel.key)}
                                        className={`icon-button glass px-4 py-3 rounded-2xl flex items-center gap-3 border border-slate-800/60 ${panelOpen[panel.key] ? 'ring-2 ring-cyan-500/40' : ''}`}
                                    >
                                        <div className="relative">
                                            <span className="w-8 h-8 rounded-xl bg-slate-900/70 flex items-center justify-center text-cyan-300">
                                                <i className={`fas ${panel.icon}`}></i>
                                            </span>
                                            <span className={`absolute -top-1 -right-1 w-2.5 h-2.5 rounded-full shadow ${statusBadgeClass(panel.status)}`}></span>
                                        </div>
                                        <div className="text-left">
                                            <p className="text-xs uppercase tracking-wider text-slate-400">{panel.label}</p>
                                            <p className="text-sm font-semibold text-slate-200">{panel.metric || 'â€”'}</p>
                                        </div>
                                        <i className={`fas fa-chevron-${panelOpen[panel.key] ? 'up' : 'down'} text-slate-600`}></i>
                                    </button>
                                ))}
                                <button
                                    type="button"
                                    onClick={handleAddParty}
                                    className="icon-button glass px-4 py-3 rounded-2xl flex items-center gap-2 text-slate-200 border border-slate-800/60 hover:border-cyan-500/50"
                                >
                                    <i className="fas fa-plus"></i>
                                    Quick Add Party
                                </button>
                            </div>

                            {panelOpen.timings && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-4">
                                      <div className="flex items-center justify-between">
                                          <button
                                              type="button"
                                              onClick={() => togglePanel('timings')}
                                              className="text-lg font-semibold text-slate-100 hover:text-cyan-200 transition flex items-center gap-2"
                                          >
                                              Timing Buckets
                                              <i className={`fas fa-chevron-${panelOpen.timings ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                          </button>
                                        <button onClick={() => togglePanel('timings')} type="button" className="text-slate-500 hover:text-slate-200">
                                            <i className="fas fa-xmark"></i>
                                        </button>
                                    </div>
                                      {['present', 'clock', 'tips', 'working'].map((bucket) => (
                                          <div key={bucket} className="grid grid-cols-1 md:grid-cols-4 gap-2 items-end">
                                              <div className="md:col-span-1">
                                                  <p className="text-xs uppercase tracking-wider text-slate-500">{bucket.toUpperCase()}</p>
                                              </div>
                                              <div className="md:col-span-1">
                                                  <label className="text-xs text-slate-500">Start</label>
                                                  <div className="mt-1 space-y-1">
                                                      <input
                                                          type="text"
                                                          inputMode="numeric"
                                                          value={getTimeDraftValue(`time.${bucket}.start`)}
                                                          onChange={(e) => handleTimeDraftChange(`time.${bucket}.start`, e.target.value)}
                                                          onBlur={(e) => commitTimeValue(`time.${bucket}.start`, e.target.value, { mode: 'start' })}
                                                          onFocus={(e) => e.target.select()}
                                                          className="w-full px-4 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                          placeholder="e.g. 4p"
                                                      />
                                                      {timeErrors[`time.${bucket}.start`] && (
                                                          <p className="text-xs text-amber-400">{timeErrors[`time.${bucket}.start`]}</p>
                                                      )}
                                                  </div>
                                              </div>
                                              <div className="md:col-span-1">
                                                  <label className="text-xs text-slate-500">End</label>
                                                  <div className="mt-1 space-y-1">
                                                      <input
                                                          type="text"
                                                          inputMode="numeric"
                                                          value={getTimeDraftValue(`time.${bucket}.end`)}
                                                          onChange={(e) => handleTimeDraftChange(`time.${bucket}.end`, e.target.value)}
                                                          onBlur={(e) =>
                                                              commitTimeValue(`time.${bucket}.end`, e.target.value, {
                                                                  mode: 'end',
                                                                  referenceStart: formData.time?.[bucket]?.start,
                                                              })
                                                          }
                                                          onFocus={(e) => e.target.select()}
                                                          className="w-full px-4 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                          placeholder="e.g. 1230"
                                                      />
                                                      {timeErrors[`time.${bucket}.end`] && (
                                                          <p className="text-xs text-amber-400">{timeErrors[`time.${bucket}.end`]}</p>
                                                      )}
                                                  </div>
                                              </div>
                                              <div className="md:col-span-1">
                                                  <label className="text-xs text-slate-500">Hours</label>
                                                  <input
                                                      type="number"
                                                      step="0.25"
                                                      value={formData.time[bucket]?.hours || ''}
                                                      onChange={(e) => updateFormPath(`time.${bucket}.hours`, e.target.value === '' ? '' : parseFloat(e.target.value))}
                                                      className="mt-1 w-full px-4 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                  />
                                              </div>
                                          </div>
                                      ))}
                                </div>
                            )}

                            {panelOpen.cuts && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('cuts')}
                                            className="flex items-center gap-2 text-lg font-semibold text-slate-100 hover:text-cyan-200 transition"
                                        >
                                            Cuts
                                            <i className={`fas fa-chevron-${panelOpen.cuts ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                        </button>
                                        <button type="button" onClick={handleAddCut} className="text-sm text-cyan-200 hover:text-white flex items-center gap-2">
                                            <i className="fas fa-plus"></i>
                                            Custom Cut
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {Object.entries(formData.cuts || {}).map(([key, cut]) => {
                                            const expanded = !!expandedCuts[key];
                        const baseCut = ['day', 'mid', 'night'].includes(key);
                                            const label = cut.label || key.charAt(0).toUpperCase() + key.slice(1);
                                            return (
                                                <div key={key} className="border border-slate-800/60 rounded-2xl p-4 bg-slate-900/40 space-y-4">
                                                    <div className="flex flex-col md:flex-row md:items-center gap-3 justify-between">
                                                        <button
                                                            type="button"
                                                            onClick={() => toggleCutDetails(key)}
                                                            className="flex items-center gap-3 text-left text-slate-100 hover:text-cyan-200 transition"
                                                        >
                                                            <span className="badge-pill bg-slate-800 text-slate-300 border border-slate-700">{label}</span>
                                                            <i className={`fas fa-chevron-${expanded ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                                        </button>
                                                        <div className="flex items-center gap-2">
                                                            <label className="text-xs uppercase text-slate-500">My Tips</label>
                                                            <input
                                                                type="text"
                                                                value={cut.me?.tips ?? ''}
                                                                onChange={(e) => updateFormPath(`cuts.${key}.me.tips`, e.target.value)}
                                                                className="px-3 py-1.5 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                placeholder="0.00"
                                                            />
                                                        </div>
                                                        {!baseCut && (
                                                            <button
                                                                type="button"
                                                                onClick={() => deleteCut(key)}
                                                                className="text-xs text-rose-300 hover:text-rose-100 px-3 py-1 border border-rose-500/40 rounded-lg"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        )}
                                                    </div>
                                                    {expanded && (
                                                        <div className="space-y-4 border-t border-slate-800/60 pt-4">
                                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Label</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.label || ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.label`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="Label"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Status</label>
                                                                    <select
                                                                        value={cut.status || 'pending'}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.status`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                    >
                                                                        <option value="pending">Pending</option>
                                                                        <option value="estimated">Estimated</option>
                                                                        <option value="confirmed">Confirmed</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">My Hours</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.me?.hours ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.me.hours`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="0"
                                                                    />
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Pool Total</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.total?.tips ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.total.tips`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="optional"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Pool Hours</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.total?.hours ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.total.hours`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="optional"
                                                                    />
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Share %</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.share?.pct ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.share.pct`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="optional"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">People</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.share?.people ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.share.people`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="optional"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Notes</label>
                                                                    <input
                                                                        type="text"
                                                                        value={cut.share?.notes ?? ''}
                                                                        onChange={(e) => updateFormPath(`cuts.${key}.share.notes`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="Team, weighting, etc."
                                                                    />
                                                                </div>
                                                            </div>
                                                            <div className="flex justify-end gap-2">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => cancelCutSection(key)}
                                                                    className="px-4 py-2 border border-slate-700 text-slate-300 rounded-xl hover:border-slate-500"
                                                                >
                                                                    Cancel
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    onClick={() => saveCutSection(key)}
                                                                    className="px-4 py-2 bg-cyan-500/20 text-cyan-200 border border-cyan-500/40 rounded-xl hover:bg-cyan-500/30"
                                                                >
                                                                    Save &amp; Close
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {panelOpen.parties && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('parties')}
                                            className="flex items-center gap-2 text-lg font-semibold text-slate-100 hover:text-cyan-200 transition"
                                        >
                                            Parties &amp; Events
                                            <i className={`fas fa-chevron-${panelOpen.parties ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                        </button>
                                        <button type="button" onClick={handleAddParty} className="text-sm text-cyan-200 hover:text-white flex items-center gap-2">
                                            <i className="fas fa-plus"></i>
                                            Add Party
                                        </button>
                                    </div>
                                    {partyCount === 0 && <p className="text-sm text-slate-500">No parties logged yet.</p>}
                                    <div className="space-y-3">
                                        {Object.entries(formData.parties || {}).map(([id, party], index) => {
                                            const expanded = !!expandedParties[id];
                                            const partyLabel = party.name || `Party ${index + 1}`;
                                            const defaultCutType = formData.type === 'day' ? 'day' : 'night';
                                            return (
                                                <div key={id} className="border border-slate-800/60 rounded-2xl p-4 bg-slate-900/40 space-y-4">
                                                    <div className="flex flex-col md:flex-row md:items-center gap-3 justify-between">
                                                        <button
                                                            type="button"
                                                            onClick={() => togglePartyDetails(id)}
                                                            className="flex items-center gap-3 text-left text-slate-100 hover:text-cyan-200 transition"
                                                        >
                                                            <span className="badge-pill bg-slate-800 text-slate-300 border border-slate-700">
                                                                {`Party ${index + 1}`}
                                                            </span>
                                                            <span>{partyLabel}</span>
                                                            <i className={`fas fa-chevron-${expanded ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                                        </button>
                                                        <div className="flex items-center gap-2">
                                                            <select
                                                                value={party.cutType || defaultCutType}
                                                                onChange={(e) => updateFormPath(`parties.${id}.cutType`, e.target.value)}
                                                                className="px-3 py-1.5 bg-slate-900/60 border border-slate-700 rounded-xl text-xs"
                                                            >
                                                                <option value="day">Day</option>
                                                                <option value="night">Night</option>
                                                            </select>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDeleteParty(id)}
                                                                className="text-xs text-rose-300 hover:text-rose-100 px-3 py-1 border border-rose-500/40 rounded-lg"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {expanded && (
                                                        <div className="space-y-4 border-t border-slate-800/60 pt-4">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Party Name</label>
                                                                    <input
                                                                        type="text"
                                                                        value={party.name || ''}
                                                                        onChange={(e) => updateFormPath(`parties.${id}.name`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="Party Name"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Location</label>
                                                                    <input
                                                                        type="text"
                                                                        value={party.location || ''}
                                                                        onChange={(e) => updateFormPath(`parties.${id}.location`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="Bar, Room, Patio..."
                                                                    />
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Start</label>
                                                                    <div className="mt-1 space-y-1">
                                                                        <input
                                                                            type="text"
                                                                            inputMode="numeric"
                                                                            value={getTimeDraftValue(`parties.${id}.time.start`)}
                                                                            onChange={(e) => handleTimeDraftChange(`parties.${id}.time.start`, e.target.value)}
                                                                            onBlur={(e) =>
                                                                                commitTimeValue(`parties.${id}.time.start`, e.target.value, {
                                                                                    mode: 'start',
                                                                                })
                                                                            }
                                                                            onFocus={(e) => e.target.select()}
                                                                            className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                            placeholder="e.g. 3"
                                                                        />
                                                                        {timeErrors[`parties.${id}.time.start`] && (
                                                                            <p className="text-xs text-amber-400">{timeErrors[`parties.${id}.time.start`]}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">End</label>
                                                                    <div className="mt-1 space-y-1">
                                                                        <input
                                                                            type="text"
                                                                            inputMode="numeric"
                                                                            value={getTimeDraftValue(`parties.${id}.time.end`)}
                                                                            onChange={(e) => handleTimeDraftChange(`parties.${id}.time.end`, e.target.value)}
                                                                            onBlur={(e) =>
                                                                                commitTimeValue(`parties.${id}.time.end`, e.target.value, {
                                                                                    mode: 'end',
                                                                                    referenceStart: party.time?.start,
                                                                                })
                                                                            }
                                                                            onFocus={(e) => e.target.select()}
                                                                            className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                            placeholder="e.g. 630"
                                                                        />
                                                                        {timeErrors[`parties.${id}.time.end`] && (
                                                                            <p className="text-xs text-amber-400">{timeErrors[`parties.${id}.time.end`]}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Gratuity</label>
                                                                    <input
                                                                        type="text"
                                                                        value={party.tips?.gratuity ?? ''}
                                                                        onChange={(e) => updateFormPath(`parties.${id}.tips.gratuity`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="â‰ˆ800"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs uppercase text-slate-500">Cash Tips</label>
                                                                    <input
                                                                        type="text"
                                                                        value={party.tips?.cashTips ?? ''}
                                                                        onChange={(e) => updateFormPath(`parties.${id}.tips.cashTips`, e.target.value)}
                                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                        placeholder="optional"
                                                                    />
                                                                </div>
                                                            </div>
                                                            <textarea
                                                                value={party.notes || ''}
                                                                onChange={(e) => updateFormPath(`parties.${id}.notes`, e.target.value)}
                                                                className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl text-sm"
                                                                placeholder="Notes (helpers, packages, setup)"
                                                            ></textarea>
                                                            <div className="flex justify-end gap-2">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => cancelPartySection(id)}
                                                                    className="px-4 py-2 border border-slate-700 text-slate-300 rounded-xl hover:border-slate-500"
                                                                >
                                                                    Cancel
                                                                </button>
                                                                <button
                                                                    type="button"
                                                                    onClick={() => savePartySection(id)}
                                                                    className="px-4 py-2 bg-cyan-500/20 text-cyan-200 border border-cyan-500/40 rounded-xl hover:bg-cyan-500/30"
                                                                >
                                                                    Save &amp; Close
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {panelOpen.coworkers && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-6">
                                    <div className="flex flex-wrap items-center justify-between gap-3">
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('coworkers')}
                                            className="flex items-center gap-2 text-lg font-semibold text-slate-100 hover:text-cyan-200 transition"
                                        >
                                            Crew Knowledge
                                            <i className={`fas fa-chevron-${panelOpen.coworkers ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                        </button>
                                        <div className="flex flex-wrap items-center gap-2">
                                            <button
                                                type="button"
                                                onClick={() => addBartenderRow({ status: 'tentative' })}
                                                className="text-xs px-3 py-1.5 rounded-lg border border-cyan-500/40 text-cyan-200 hover:bg-cyan-500/10"
                                            >
                                                <i className="fas fa-user-plus mr-2"></i>Bartender
                                            </button>
                                            <button
                                                type="button"
                                                onClick={addServerRow}
                                                className="text-xs px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 hover:border-cyan-500/40"
                                            >
                                                <i className="fas fa-clipboard-list mr-2"></i>Server
                                            </button>
                                            <button
                                                type="button"
                                                onClick={addSupportRow}
                                                className="text-xs px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 hover:border-cyan-500/40"
                                            >
                                                <i className="fas fa-user-shield mr-2"></i>Support
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-xs text-slate-400">
                                        Track who was on the floor with you, their tentative schedule, actual times, and where they landed.
                                        Use the quick buttons to populate blanks or adjust estimates as the night unfolds.
                                    </p>

                                    <div className="space-y-6">
                                        <div className="space-y-3">
                                            <div className="flex flex-wrap items-center justify-between gap-2">
                                                <h4 className="text-sm font-semibold text-slate-200">Night Crew Â· Bartenders</h4>
                                                <span className="text-xs text-slate-400">{(formData.coworkers?.bartenders || []).length} logged</span>
                                            </div>
                                            {(formData.coworkers?.bartenders || []).length === 0 ? (
                                                <p className="text-sm text-slate-500">No bartenders logged yet. Add the teammates scheduled with you for this shift.</p>
                                            ) : (
                                                (formData.coworkers?.bartenders || []).map((member, index) => (
                                                    <div
                                                        key={`bartender-${index}`}
                                                        className={`border border-slate-800/60 rounded-2xl bg-slate-900/40 p-4 space-y-3 ${
                                                            member.isSelf ? 'border-cyan-500/50 bg-cyan-500/10' : ''
                                                        }`}
                                                    >
                                                        <div className="flex flex-wrap items-start gap-3">
                                                            <div className="flex-1 min-w-[180px]">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Name</label>
                                                                <input
                                                                    type="text"
                                                                    list="bartender-name-options"
                                                                    value={member.name || ''}
                                                                    onChange={(e) => handleBartenderNameChange(index, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="Start typing..."
                                                                />
                                                                <div className="flex flex-wrap gap-2 mt-2">
                                                                    {member.isSelf && (
                                                                        <span className="badge-pill bg-cyan-500/30 text-cyan-100 border border-cyan-400/40">You</span>
                                                                    )}
                                                                    {member.isManager && (
                                                                        <span className="badge-pill bg-amber-500/20 text-amber-100 border border-amber-400/40">Manager</span>
                                                                    )}
                                                                    {member.positions && member.positions.length > 0 && (
                                                                        <span className="badge-pill bg-slate-800 text-slate-300 border border-slate-700">
                                                                            {member.positions.join(', ')}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="w-32">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Status</label>
                                                                <select
                                                                    value={member.status || 'tentative'}
                                                                    onChange={(e) => updateFormPath(`coworkers.bartenders.${index}.status`, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                >
                                                                    {BARTENDER_STATUS_OPTIONS.map((option) => (
                                                                        <option key={option.value} value={option.value}>
                                                                            {option.label}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <div className="w-40">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Location</label>
                                                                <select
                                                                    value={member.location || ''}
                                                                    onChange={(e) => updateFormPath(`coworkers.bartenders.${index}.location`, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                >
                                                                    {BARTENDER_LOCATION_OPTIONS.map((option) => (
                                                                        <option key={option.value || 'na'} value={option.value}>
                                                                            {option.label}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                disabled={member.isSelf}
                                                                onClick={() => removeBartenderRow(index)}
                                                                className={`text-xs px-3 py-2 border rounded-xl ${
                                                                    member.isSelf
                                                                        ? 'border-slate-700 text-slate-600 cursor-not-allowed'
                                                                        : 'border-rose-500/40 text-rose-200 hover:bg-rose-500/20'
                                                                }`}
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Scheduled Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.bartenders.${index}.start`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.bartenders.${index}.start`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.bartenders.${index}.start`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="5"
                                                                />
                                                                {timeErrors[`coworkers.bartenders.${index}.start`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.bartenders.${index}.start`]}</p>
                                                                )}
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Scheduled End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.bartenders.${index}.end`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.bartenders.${index}.end`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.bartenders.${index}.end`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="2"
                                                                />
                                                                {timeErrors[`coworkers.bartenders.${index}.end`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.bartenders.${index}.end`]}</p>
                                                                )}
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.bartenders.${index}.actualStart`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.bartenders.${index}.actualStart`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.bartenders.${index}.actualStart`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="5"
                                                                />
                                                                {timeErrors[`coworkers.bartenders.${index}.actualStart`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.bartenders.${index}.actualStart`]}</p>
                                                                )}
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.bartenders.${index}.actualEnd`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.bartenders.${index}.actualEnd`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.bartenders.${index}.actualEnd`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.actualStart || member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="2"
                                                                />
                                                                {timeErrors[`coworkers.bartenders.${index}.actualEnd`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.bartenders.${index}.actualEnd`]}</p>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex flex-wrap items-center gap-2">
                                                            <button
                                                                type="button"
                                                                onClick={() => syncBartenderActualTimes(index)}
                                                                className="text-[11px] px-3 py-1 border border-slate-700 rounded-lg text-slate-200 hover:border-cyan-500/50"
                                                            >
                                                                Copy scheduled times to actual
                                                            </button>
                                                        </div>
                                                        <textarea
                                                            value={member.notes || ''}
                                                            onChange={(e) => updateFormPath(`coworkers.bartenders.${index}.notes`, e.target.value)}
                                                            className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                            placeholder="Location notes, coverage swaps, call-outs, etc."
                                                        ></textarea>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        <div className="space-y-3">
                                            <div className="flex flex-wrap items-center justify-between gap-2">
                                                <h4 className="text-sm font-semibold text-slate-200">Servers</h4>
                                                <span className="text-xs text-slate-400">{(formData.coworkers?.servers || []).length} logged</span>
                                            </div>
                                            {(formData.coworkers?.servers || []).length === 0 ? (
                                                <p className="text-sm text-slate-500">Log the servers you coordinated with, their start times, and cut order for easier recap later.</p>
                                            ) : (
                                                (formData.coworkers?.servers || []).map((member, index) => (
                                                    <div
                                                        key={`server-${index}`}
                                                        className="border border-slate-800/60 rounded-2xl bg-slate-900/40 p-4 space-y-3"
                                                    >
                                                        <div className="flex flex-wrap items-start gap-3">
                                                            <div className="flex-1 min-w-[160px]">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Name</label>
                                                                <input
                                                                    type="text"
                                                                    list="server-name-options"
                                                                    value={member.name || ''}
                                                                    onChange={(e) => handleServerNameChange(index, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="Server name"
                                                                />
                                                            </div>
                                                            <div className="w-32">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Cut Order</label>
                                                                <input
                                                                    type="number"
                                                                    min="1"
                                                                    value={member.order || ''}
                                                                    onChange={(e) => updateFormPath(`coworkers.servers.${index}.order`, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="#"
                                                                />
                                                            </div>
                                                            <div className="w-36">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Tip Out</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="decimal"
                                                                    value={member.tipOut ?? ''}
                                                                    onChange={(e) => updateFormPath(`coworkers.servers.${index}.tipOut`, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="Amount"
                                                                />
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => removeServerRow(index)}
                                                                className="text-xs px-3 py-2 border border-rose-500/40 text-rose-200 rounded-xl hover:bg-rose-500/20"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Scheduled Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.servers.${index}.start`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.servers.${index}.start`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.servers.${index}.start`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="4"
                                                                />
                                                                {timeErrors[`coworkers.servers.${index}.start`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.servers.${index}.start`]}</p>
                                                                )}
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Scheduled End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.servers.${index}.end`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.servers.${index}.end`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.servers.${index}.end`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="11"
                                                                />
                                                                {timeErrors[`coworkers.servers.${index}.end`] && (
                                                                    <p className="text-xs text-amber-400">{timeErrors[`coworkers.servers.${index}.end`]}</p>
                                                                )}
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.servers.${index}.actualStart`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.servers.${index}.actualStart`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.servers.${index}.actualStart`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="4"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.servers.${index}.actualEnd`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.servers.${index}.actualEnd`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.servers.${index}.actualEnd`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.actualStart || member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="11"
                                                                />
                                                            </div>
                                                        </div>
                                                        <textarea
                                                            value={member.notes || ''}
                                                            onChange={(e) => updateFormPath(`coworkers.servers.${index}.notes`, e.target.value)}
                                                            className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                            placeholder="Cut flow, sections, or anything notable."
                                                        ></textarea>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        <div className="space-y-3">
                                            <div className="flex flex-wrap items-center justify-between gap-2">
                                                <h4 className="text-sm font-semibold text-slate-200">Support Roles</h4>
                                                <span className="text-xs text-slate-400">{(formData.coworkers?.support || []).length} logged</span>
                                            </div>
                                            {(formData.coworkers?.support || []).length === 0 ? (
                                                <p className="text-sm text-slate-500">Capture host, busser, door, or expo coverage if it helps your recap.</p>
                                            ) : (
                                                (formData.coworkers?.support || []).map((member, index) => (
                                                    <div
                                                        key={`support-${index}`}
                                                        className="border border-slate-800/60 rounded-2xl bg-slate-900/40 p-4 space-y-3"
                                                    >
                                                        <div className="flex flex-wrap items-start gap-3">
                                                            <div className="w-36">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Role</label>
                                                                <select
                                                                    value={member.role || 'Host'}
                                                                    onChange={(e) => updateFormPath(`coworkers.support.${index}.role`, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                >
                                                                    {SUPPORT_ROLE_OPTIONS.map((role) => (
                                                                        <option key={role} value={role}>
                                                                            {role}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                            </div>
                                                            <div className="flex-1 min-w-[160px]">
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Name</label>
                                                                <input
                                                                    type="text"
                                                                    list="support-name-options"
                                                                    value={member.name || ''}
                                                                    onChange={(e) => handleSupportNameChange(index, e.target.value)}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                    placeholder="Support teammate"
                                                                />
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => removeSupportRow(index)}
                                                                className="text-xs px-3 py-2 border border-rose-500/40 text-rose-200 rounded-xl hover:bg-rose-500/20"
                                                            >
                                                                <i className="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.support.${index}.start`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.support.${index}.start`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.support.${index}.start`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.support.${index}.end`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.support.${index}.end`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.support.${index}.end`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual Start</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.support.${index}.actualStart`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.support.${index}.actualStart`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.support.${index}.actualStart`, e.target.value, { mode: 'start' })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="text-xs uppercase text-slate-500 block mb-1">Actual End</label>
                                                                <input
                                                                    type="text"
                                                                    inputMode="numeric"
                                                                    value={getTimeDraftValue(`coworkers.support.${index}.actualEnd`)}
                                                                    onChange={(e) => handleTimeDraftChange(`coworkers.support.${index}.actualEnd`, e.target.value)}
                                                                    onBlur={(e) =>
                                                                        commitTimeValue(`coworkers.support.${index}.actualEnd`, e.target.value, {
                                                                            mode: 'end',
                                                                            referenceStart: member.actualStart || member.start || formData.time?.base?.start,
                                                                        })
                                                                    }
                                                                    onFocus={(e) => e.target.select()}
                                                                    className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                                />
                                                            </div>
                                                        </div>
                                                        <textarea
                                                            value={member.notes || ''}
                                                            onChange={(e) => updateFormPath(`coworkers.support.${index}.notes`, e.target.value)}
                                                            className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                            placeholder="Notes or context for this support role."
                                                        ></textarea>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        <div className="space-y-3">
                                            <h4 className="text-sm font-semibold text-slate-200">Fallbacks &amp; Notes</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div>
                                                    <label className="text-xs uppercase text-slate-500 block mb-1">Default Cut Time (Schedule)</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            inputMode="numeric"
                                                            value={getTimeDraftValue('coworkers.estimates.fallbackEnd')}
                                                            onChange={(e) => handleTimeDraftChange('coworkers.estimates.fallbackEnd', e.target.value)}
                                                            onBlur={(e) =>
                                                                commitTimeValue('coworkers.estimates.fallbackEnd', e.target.value, {
                                                                    mode: 'end',
                                                                    referenceStart: formData.time?.base?.start,
                                                                })
                                                            }
                                                            onFocus={(e) => e.target.select()}
                                                            className="flex-1 px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                            placeholder="2"
                                                        />
                                                        <button
                                                            type="button"
                                                            onClick={() => applyFallbackToBartenders('fallbackEnd')}
                                                            className="text-xs px-3 py-2 border border-slate-700 text-slate-200 rounded-xl hover:border-cyan-500/40"
                                                        >
                                                            Apply
                                                        </button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-xs uppercase text-slate-500 block mb-1">Default Cut Time (Actual)</label>
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            inputMode="numeric"
                                                            value={getTimeDraftValue('coworkers.estimates.fallbackActualEnd')}
                                                            onChange={(e) => handleTimeDraftChange('coworkers.estimates.fallbackActualEnd', e.target.value)}
                                                            onBlur={(e) =>
                                                                commitTimeValue('coworkers.estimates.fallbackActualEnd', e.target.value, {
                                                                    mode: 'end',
                                                                    referenceStart: formData.time?.base?.start,
                                                                })
                                                            }
                                                            onFocus={(e) => e.target.select()}
                                                            className="flex-1 px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                            placeholder="2"
                                                        />
                                                        <button
                                                            type="button"
                                                            onClick={() => applyFallbackToBartenders('fallbackActualEnd')}
                                                            className="text-xs px-3 py-2 border border-slate-700 text-slate-200 rounded-xl hover:border-cyan-500/40"
                                                        >
                                                            Apply
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <textarea
                                                value={formData.coworkers?.estimates?.notes || ''}
                                                onChange={(e) => updateFormPath('coworkers.estimates.notes', e.target.value)}
                                                className="w-full px-3 py-2 bg-slate-900/70 border border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500"
                                                placeholder="General observations, shift swaps, schedule changes, or anything to remember next time."
                                            ></textarea>
                                        </div>
                                    </div>

                                    <datalist id="bartender-name-options">
                                        {bartenderDirectory.map((member) => (
                                            <option key={`bartender-option-${member.id}`} value={member.name} />
                                        ))}
                                    </datalist>
                                    <datalist id="server-name-options">
                                        {serverDirectory.map((member) => (
                                            <option key={`server-option-${member.id}`} value={member.name} />
                                        ))}
                                    </datalist>
                                    <datalist id="support-name-options">
                                        {supportDirectory.map((member) => (
                                            <option key={`support-option-${member.id}`} value={member.name} />
                                        ))}
                                    </datalist>
                                </div>
                            )}

                            {panelOpen.enhancements && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-6">
                                    <div className="flex items-center justify-between">
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('enhancements')}
                                            className="flex items-center gap-2 text-lg font-semibold text-slate-100 hover:text-cyan-200 transition"
                                        >
                                            Enhancements &amp; Adjustments
                                            <i className={`fas fa-chevron-${panelOpen.enhancements ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                        </button>
                                        <div className="text-xs text-slate-500">Group overtime, consideration, swindle</div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-slate-900/40 border border-slate-800/60 rounded-2xl p-4">
                                            <p className="text-xs uppercase tracking-wider text-slate-500">Wage</p>
                                            <div className="mt-3 space-y-3">
                                                <div>
                                                    <label className="text-xs uppercase text-slate-500">Base Rate</label>
                                                    <input
                                                        type="text"
                                                        value={formData.wage.base ?? ''}
                                                        onChange={(e) => updateFormPath('wage.base', e.target.value)}
                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                        placeholder="5.00"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-xs uppercase text-slate-500">Hours</label>
                                                    <input
                                                        type="text"
                                                        value={formData.wage.hours ?? ''}
                                                        onChange={(e) => updateFormPath('wage.hours', e.target.value)}
                                                        className="mt-1 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                        placeholder="6"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-xs uppercase text-slate-500">Clock Start</label>
                                                        <div className="mt-1 space-y-1">
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                value={getTimeDraftValue('wage.clock.start')}
                                                                onChange={(e) => handleTimeDraftChange('wage.clock.start', e.target.value)}
                                                                onBlur={(e) => commitTimeValue('wage.clock.start', e.target.value, { mode: 'start' })}
                                                                onFocus={(e) => e.target.select()}
                                                                className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                placeholder="10"
                                                            />
                                                            {timeErrors['wage.clock.start'] && (
                                                                <p className="text-xs text-amber-400">{timeErrors['wage.clock.start']}</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs uppercase text-slate-500">Clock End</label>
                                                        <div className="mt-1 space-y-1">
                                                            <input
                                                                type="text"
                                                                inputMode="numeric"
                                                                value={getTimeDraftValue('wage.clock.end')}
                                                                onChange={(e) => handleTimeDraftChange('wage.clock.end', e.target.value)}
                                                                onBlur={(e) =>
                                                                    commitTimeValue('wage.clock.end', e.target.value, {
                                                                        mode: 'end',
                                                                        referenceStart: formData.wage?.clock?.start,
                                                                    })
                                                                }
                                                                onFocus={(e) => e.target.select()}
                                                                className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                                placeholder="6p"
                                                            />
                                                            {timeErrors['wage.clock.end'] && (
                                                                <p className="text-xs text-amber-400">{timeErrors['wage.clock.end']}</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                                {wageClockHours != null && (
                                                    <p className="text-xs text-slate-500">
                                                        Clocked {wageClockHours.toFixed(2)} hours
                                                    </p>
                                                )}
                                                <p className="text-xs text-slate-500">Total ${wageTotal.toFixed(2)}</p>
                                            </div>
                                        </div>
                                        <div className="bg-slate-900/40 border border-slate-800/60 rounded-2xl p-4">
                                            <p className="text-xs uppercase tracking-wider text-slate-500">Overtime</p>
                                            <input
                                                type="text"
                                                value={formData.earnings.overtime ?? ''}
                                                onChange={(e) => updateFormPath('earnings.overtime', e.target.value)}
                                                className="mt-3 w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="0.00"
                                            />
                                        </div>
                                        <div className="bg-slate-900/40 border border-slate-800/60 rounded-2xl p-4">
                                            <div className="flex items-center justify-between">
                                                <p className="text-xs uppercase tracking-wider text-slate-500">Chump</p>
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs text-slate-500">Played?</label>
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.chump?.played || false}
                                                        onChange={(e) => updateFormPath('chump.played', e.target.checked)}
                                                        className="accent-cyan-500"
                                                    />
                                                </div>
                                            </div>
                                            <div className="mt-3 space-y-2">
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.chump?.amount?.total || ''}
                                                    onChange={(e) => updateFormPath('chump.amount.total', e.target.value)}
                                                    className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Pot total"
                                                />
                                                <input
                                                    type="text"
                                                    value={formData.chump?.winner || ''}
                                                    onChange={(e) => updateFormPath('chump.winner', e.target.value)}
                                                    className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Winner"
                                                />
                                                <textarea
                                                    value={formData.chump?.notes || ''}
                                                    onChange={(e) => updateFormPath('chump.notes', e.target.value)}
                                                    className="w-full px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl text-sm"
                                                    placeholder="Notes"
                                                ></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-800/60 rounded-2xl p-4 bg-slate-900/40 space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-semibold text-slate-200">Consideration</h4>
                                            <button type="button" onClick={handleAddConsideration} className="text-xs text-cyan-200 hover:text-white flex items-center gap-2">
                                                <i className="fas fa-plus"></i>
                                                Item
                                            </button>
                                        </div>
                                        {(formData.consideration?.items || []).map((item, idx) => (
                                            <div key={idx} className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                <input
                                                    type="text"
                                                    value={item.from || ''}
                                                    onChange={(e) => updateFormPath(`consideration.items.${idx}.from`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="From"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={item.amount || ''}
                                                    onChange={(e) => updateFormPath(`consideration.items.${idx}.amount`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Amount"
                                                />
                                                <input
                                                    type="text"
                                                    value={item.reason || ''}
                                                    onChange={(e) => updateFormPath(`consideration.items.${idx}.reason`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Reason"
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    <div className="border border-slate-800/60 rounded-2xl p-4 bg-slate-900/40 space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h4 className="text-sm font-semibold text-slate-200">Swindle Movements</h4>
                                            <button type="button" onClick={handleAddSwindleMovement} className="text-xs text-cyan-200 hover:text-white flex items-center gap-2">
                                                <i className="fas fa-plus"></i>
                                                Movement
                                            </button>
                                        </div>
                                        {(formData.swindle?.movements || []).map((move, idx) => (
                                            <div key={idx} className="grid grid-cols-1 md:grid-cols-4 gap-2">
                                                <input
                                                    type="text"
                                                    value={move.from || ''}
                                                    onChange={(e) => updateFormPath(`swindle.movements.${idx}.from`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="From"
                                                />
                                                <input
                                                    type="text"
                                                    value={move.to || ''}
                                                    onChange={(e) => updateFormPath(`swindle.movements.${idx}.to`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="To"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={move.amount || ''}
                                                    onChange={(e) => updateFormPath(`swindle.movements.${idx}.amount`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Amount"
                                                />
                                                <input
                                                    type="text"
                                                    value={move.note || ''}
                                                    onChange={(e) => updateFormPath(`swindle.movements.${idx}.note`, e.target.value)}
                                                    className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                    placeholder="Note"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {panelOpen.drinking && (
                                <div className="glass rounded-2xl p-6 border border-slate-800/60 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <button
                                            type="button"
                                            onClick={() => togglePanel('drinking')}
                                            className="flex items-center gap-2 text-lg font-semibold text-slate-100 hover:text-cyan-200 transition"
                                        >
                                            On-Shift Drinking
                                            <i className={`fas fa-chevron-${panelOpen.drinking ? 'up' : 'down'} text-xs text-slate-500`}></i>
                                        </button>
                                        <button type="button" onClick={handleAddDrinkingItem} className="text-sm text-cyan-200 hover:text-white flex items-center gap-2">
                                            <i className="fas fa-plus"></i>
                                            Add Item
                                        </button>
                                    </div>
                                    {(formData.drinking?.items || []).map((item, idx) => (
                                        <div key={idx} className="grid grid-cols-1 md:grid-cols-6 gap-2">
                                            <input
                                                type="text"
                                                value={item.name || ''}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.name`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="Name"
                                            />
                                            <input
                                                type="text"
                                                value={item.code || ''}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.code`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="Code"
                                            />
                                            <input
                                                type="number"
                                                step="0.1"
                                                value={item.abv || ''}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.abv`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="ABV%"
                                            />
                                            <input
                                                type="number"
                                                step="0.5"
                                                value={item.oz || ''}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.oz`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="Oz"
                                            />
                                            <input
                                                type="number"
                                                step="0.1"
                                                value={item.quantity || 1}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.quantity`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="Qty"
                                            />
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={item.sbe || ''}
                                                onChange={(e) => updateFormPath(`drinking.items.${idx}.sbe`, e.target.value)}
                                                className="px-3 py-2 bg-slate-900/60 border border-slate-700 rounded-xl"
                                                placeholder="SBE"
                                            />
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div className="flex flex-col gap-4">
                                <textarea
                                    value={formData.meta?.notes || ''}
                                    onChange={(e) => updateFormPath('meta.notes', e.target.value)}
                                    className="w-full min-h-[120px] px-4 py-3 bg-slate-900/60 border border-slate-700 rounded-2xl text-sm"
                                    placeholder="Context, observations, weather, promotions..."
                                ></textarea>
                                <div className="flex gap-4">
                                    <button
                                        type="submit"
                                        className="flex-1 bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white px-8 py-4 rounded-2xl font-semibold text-lg shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 transition"
                                    >
                                        <i className="fas fa-save mr-3"></i>
                                        Save Shift
                                    </button>
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="px-6 py-4 rounded-2xl border border-slate-700 text-slate-300 hover:border-slate-500"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Shift Detail Component
        function ShiftDetail({ shift, onEdit, onClose }) {
            return (
                <div className="glass rounded-2xl shadow-xl p-6 animate-slide-in border border-slate-800/40">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold text-slate-100">
                            Shift Details - {new Date(shift.date).toLocaleDateString()}
                        </h2>
                        <div className="flex gap-2">
                            <button
                                onClick={onEdit}
                                className="bg-gradient-to-r from-cyan-500 to-fuchsia-500 text-white px-4 py-2 rounded-xl hover:shadow-lg hover:shadow-cyan-500/30 transition-all duration-300"
                            >
                                <i className="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button
                                onClick={onClose}
                                className="bg-slate-900/70 border border-slate-700 text-slate-200 px-4 py-2 rounded-xl hover:border-cyan-500 transition-all duration-300"
                            >
                                <i className="fas fa-times mr-2"></i>Close
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-slate-900/70 rounded-xl p-4 border border-slate-800/60">
                            <h3 className="font-semibold text-slate-100 mb-3">Basic Information</h3>
                            <div className="space-y-2 text-slate-300 text-sm">
                                <div className="flex justify-between">
                                    <span>Date:</span>
                                    <span className="font-semibold text-slate-100">{shift.date}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Type:</span>
                                    <span className="font-semibold text-slate-100 capitalize">{shift.type}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Name:</span>
                                    <span className="font-semibold text-slate-100">{shift.myName}</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-900/70 rounded-xl p-4 border border-slate-800/60">
                            <h3 className="font-semibold text-slate-100 mb-3">Time</h3>
                            <div className="space-y-2 text-slate-300 text-sm">
                                <div className="flex justify-between">
                                    <span>Start:</span>
                                          <span className="font-semibold text-slate-100">{formatTimeDisplay(shift.time?.base?.start)}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>End:</span>
                                          <span className="font-semibold text-slate-100">{formatTimeDisplay(shift.time?.base?.end)}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Hours:</span>
                                    <span className="font-semibold text-slate-100">{shift.time?.base?.hours?.toFixed(1)}h</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-900/70 rounded-xl p-4 border border-slate-800/60">
                            <h3 className="font-semibold text-slate-100 mb-3">Earnings Breakdown</h3>
                            <div className="space-y-2 text-sm text-slate-300">
                                  <div className="flex justify-between">
                                      <span>Tips:</span>
                                      <span className="font-semibold text-cyan-300">${Number(shift.earnings?.tips ?? 0).toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between">
                                      <span>Wage:</span>
                                      <span className="font-semibold text-emerald-300">${Number(shift.earnings?.wage ?? 0).toFixed(2)}</span>
                                  </div>
                                  {Number(shift.earnings?.overtime ?? 0) > 0 && (
                                      <div className="flex justify-between">
                                          <span>Overtime:</span>
                                          <span className="font-semibold text-amber-300">${Number(shift.earnings?.overtime ?? 0).toFixed(2)}</span>
                                      </div>
                                  )}
                                  <div className="flex justify-between pt-2 border-t border-slate-800/60 text-slate-100">
                                      <span className="font-semibold">Total:</span>
                                      <span className="font-bold text-xl text-emerald-300">${Number(shift.earnings?.total ?? 0).toFixed(2)}</span>
                                  </div>
                            </div>
                        </div>

                        <div className="bg-slate-900/70 rounded-xl p-4 border border-slate-800/60">
                            <h3 className="font-semibold text-slate-100 mb-3">Performance Summary</h3>
                            <div className="space-y-2 text-sm text-slate-300">
                                <div className="flex justify-between">
                                    <span>Hourly Rate:</span>
                                      <span className="font-bold text-lg text-indigo-300">${Number(shift.summary?.hourly ?? 0).toFixed(2)}/hr</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>Tips/Hour:</span>
                                      <span className="font-semibold text-fuchsia-300">${Number(shift.summary?.tips?.actual?.perHour ?? 0).toFixed(2)}/hr</span>
                                </div>
                                  <div className="flex justify-between">
                                      <span>Total Hours:</span>
                                      <span className="font-semibold text-slate-100">{Number(shift.summary?.hours ?? 0).toFixed(1)}h</span>
                                  </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 bg-slate-900/70 rounded-xl p-4 border border-slate-800/60">
                        <details>
                            <summary className="font-semibold text-slate-100 cursor-pointer hover:text-cyan-300">
                                View Raw JSON Data
                            </summary>
                            <pre className="mt-3 text-xs bg-slate-950 p-4 rounded border border-slate-800 overflow-x-auto scrollbar-thin text-slate-300">
{JSON.stringify(shift, null, 2)}
                            </pre>
                        </details>
                    </div>
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
